<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[channelæ•°æ®ç»“æ„]]></title>
      <url>/2017/10/26/channel%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      <content type="html"><![CDATA[<p><img src="http://oyft9mgwt.bkt.clouddn.com/channel%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<p>channelæ˜¯goè¯­è¨€çš„ä¸€å¤§ç‰¹è‰²ï¼Œä½¿ç”¨åŸå­å‡½æ•°è¿˜æ˜¯ä½¿ç”¨äº’æ–¥é”éƒ½ä¸å¦‚ä½¿ç”¨channelæ¥çš„ç®€å•ï¼Œgoè¯­è¨€ä¸­çš„channelå¯ä»¥ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’å’Œè¿”å›å€¼è¿”å›ï¼Œé€šè¿‡å‘é€å’Œæ¥å—æ•°æ®åœ¨goroutineä¹‹é—´åŒæ­¥(åœ¨å­¦ä¹ å’Œä½¿ç”¨goè¯­è¨€çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥ç‰¢è®°ï¼Œgoè¯­è¨€ä¸­æ‰€æœ‰çš„ç»“æ„éƒ½æ˜¯å€¼æ‹·è´çš„)<br>æœ¬æ–‡ä¸å¯¹channelä½¿ç”¨ä½œè®²è§£ï¼Œç›´æ¥ä¸Šé…¸(dai)èœ(ma):<br><a id="more"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">type hchan struct &#123;</div><div class="line">	qcount   uint           //é˜Ÿåˆ—æ•°æ®æ€»çš„æ•°æ®æ•°é‡</div><div class="line">	dataqsiz uint           //ç¯å½¢é˜Ÿåˆ—çš„æ•°æ®å¤§å° </div><div class="line">	buf      unsafe.Pointer //æŒ‡å‘dataqsizå…ƒç´ ç±»å‹å¤§å°çš„æ•°ç»„</div><div class="line">	elemsize uint16</div><div class="line">	closed   uint32</div><div class="line">	elemtype *_type // å…ƒç´ ç±»å‹</div><div class="line">	sendx    uint   // å‘é€æ•°æ®æ—¶çš„æ¸¸æ ‡</div><div class="line">	recvx    uint   // æ¥æ”¶æ•°æ®æ—¶çš„æ¸¸æ ‡</div><div class="line">	recvq    waitq  // æ¥æ”¶è€Œé˜»å¡çš„ç­‰å¾…é˜Ÿåˆ—</div><div class="line">	sendq    waitq  // å‘é€è€Œé˜»å¡çš„ç­‰å¾…é˜Ÿåˆ—</div><div class="line">        lock mutex      // ä¿æŠ¤hchanæ‰€æœ‰å­—æ®µçš„é”</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>hchan æ˜¯chançš„ç»“æ„ä½“ï¼Œåœ¨hchanç»“æ„ä¸­qcountå’ŒelemsizeæŒ‡å®šé˜Ÿåˆ—çš„å®¹é‡å’Œä½¿ç”¨é‡ï¼Œdataqsizé˜Ÿåˆ—çš„å¤§å°ï¼Œæ•´ä¸ªhchanç»“æ„ä½“åªè®°å½•äº†é˜Ÿåˆ—å¤§å°ç›¸å…³çš„å€¼ï¼Œå¸¦æœ‰ç¼“å†²åŒºçš„chanéœ€è¦makeçš„æ—¶å€™æŒ‡å®šï¼Œæˆ‘ä»¬ç®€å•çš„çœ‹ä¸€ä¸‹chançš„makeæ–¹æ³•æ˜¯å¦‚ä½•åˆ†é…ç¼“å†²åŒºçš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">func makechan(t *chantype, size int64) *hchan &#123;</div><div class="line">	elem := t.elem</div><div class="line">	</div><div class="line">        ...</div><div class="line">        ...</div><div class="line"></div><div class="line">	var c *hchan</div><div class="line">	if elem.kind&amp;kindNoPointers != 0 || size == 0 &#123;</div><div class="line">		c = (*hchan)(mallocgc(hchanSize+uintptr(size)*elem.size, nil, true))</div><div class="line">		if size &gt; 0 &amp;&amp; elem.size != 0 &#123;</div><div class="line">			c.buf = add(unsafe.Pointer(c), hchanSize)</div><div class="line">		&#125; else &#123;</div><div class="line">			c.buf = unsafe.Pointer(c)</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		c = new(hchan)</div><div class="line">		c.buf = newarray(elem, int(size))</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>makechan å°†hchanåˆå§‹åŒ–0å€¼ä¹‹åå¹¶åˆ¤æ–­sizeå¦‚æœæ˜¯æœ‰ç¼“å†²åŒºçš„chanåˆ™ç´§æŒ¨ç€hchanç»“æ„ä½“ä¸­åˆ†é…sizeå¤§å°çš„ â€œ_typeâ€ ç±»å‹çš„æ•°ç»„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">type waitq struct &#123;</div><div class="line">	first *sudog</div><div class="line">	last  *sudog</div><div class="line">&#125;</div><div class="line">type sudog struct &#123;</div><div class="line">	g          *g</div><div class="line">	selectdone *uint32 </div><div class="line">	next       *sudog</div><div class="line">	prev       *sudog</div><div class="line">	elem       unsafe.Pointer </div><div class="line"></div><div class="line">	acquiretime int64</div><div class="line">	releasetime int64</div><div class="line">	ticket      uint32</div><div class="line">	waitlink    *sudog // g.waiting list</div><div class="line">	c           *hchan // channel</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>gå’Œelemåˆ†åˆ«å­˜å‚¨goroutineçš„æ•°æ®</p>
<p>å‘é€channel<br>å‘channelä¸­å†™æ•°æ®æ—¶åœ¨runtimeåŒ…ä¸­å¯¹åº”çš„æ˜¯ï¼Œä»¥ä¸‹æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">func chansend(t *chantype, c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool &#123;</div><div class="line">	if raceenabled &#123;</div><div class="line">		raceReadObjectPC(t.elem, ep, callerpc, funcPC(chansend))</div><div class="line">	&#125;</div><div class="line">	if msanenabled &#123;</div><div class="line">		msanread(ep, t.elem.size)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c == nil &#123;</div><div class="line">		if !block &#123;</div><div class="line">			return false</div><div class="line">		&#125;</div><div class="line">		gopark(nil, nil, &quot;chan send (nil chan)&quot;, traceEvGoStop, 2)</div><div class="line">		throw(&quot;unreachable&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if debugChan &#123;</div><div class="line">		print(&quot;chansend: chan=&quot;, c, &quot;\n&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if raceenabled &#123;</div><div class="line">		racereadpc(unsafe.Pointer(c), callerpc, funcPC(chansend))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	</div><div class="line">	if !block &amp;&amp; c.closed == 0 &amp;&amp; ((c.dataqsiz == 0 &amp;&amp; c.recvq.first == nil) ||</div><div class="line">		(c.dataqsiz &gt; 0 &amp;&amp; c.qcount == c.dataqsiz)) &#123;</div><div class="line">		return false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	var t0 int64</div><div class="line">	if blockprofilerate &gt; 0 &#123;</div><div class="line">		t0 = cputicks()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lock(&amp;c.lock)</div><div class="line"></div><div class="line">	if c.closed != 0 &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		panic(plainError(&quot;send on closed channel&quot;))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if sg := c.recvq.dequeue(); sg != nil &#123;</div><div class="line">		send(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;)</div><div class="line">		return true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c.qcount &lt; c.dataqsiz &#123;</div><div class="line">		qp := chanbuf(c, c.sendx)</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(qp)</div><div class="line">			racerelease(qp)</div><div class="line">		&#125;</div><div class="line">		typedmemmove(c.elemtype, qp, ep)</div><div class="line">		c.sendx++</div><div class="line">		if c.sendx == c.dataqsiz &#123;</div><div class="line">			c.sendx = 0</div><div class="line">		&#125;</div><div class="line">		c.qcount++</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if !block &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	gp := getg()</div><div class="line">	mysg := acquireSudog()</div><div class="line">	mysg.releasetime = 0</div><div class="line">	if t0 != 0 &#123;</div><div class="line">		mysg.releasetime = -1</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	mysg.elem = ep</div><div class="line">	mysg.waitlink = nil</div><div class="line">	mysg.g = gp</div><div class="line">	mysg.selectdone = nil</div><div class="line">	mysg.c = c</div><div class="line">	gp.waiting = mysg</div><div class="line">	gp.param = nil</div><div class="line">	c.sendq.enqueue(mysg)</div><div class="line">	goparkunlock(&amp;c.lock, &quot;chan send&quot;, traceEvGoBlockSend, 3)</div><div class="line"></div><div class="line">	</div><div class="line">	if mysg != gp.waiting &#123;</div><div class="line">		throw(&quot;G waiting list is corrupted&quot;)</div><div class="line">	&#125;</div><div class="line">	gp.waiting = nil</div><div class="line">	if gp.param == nil &#123;</div><div class="line">		if c.closed == 0 &#123;</div><div class="line">			throw(&quot;chansend: spurious wakeup&quot;)</div><div class="line">		&#125;</div><div class="line">		panic(plainError(&quot;send on closed channel&quot;))</div><div class="line">	&#125;</div><div class="line">	gp.param = nil</div><div class="line">	if mysg.releasetime &gt; 0 &#123;</div><div class="line">		blockevent(mysg.releasetime-t0, 2)</div><div class="line">	&#125;</div><div class="line">	mysg.c = nil</div><div class="line">	releaseSudog(mysg)</div><div class="line">	return true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å‘é€æ•°æ®æ—¶å…ˆåˆ¤æ–­channelç±»å‹ï¼Œå¦‚æœæœ‰ç¼“å†²åŒºï¼Œåˆ¤æ–­channelæ˜¯å¦è¿˜æœ‰ç©ºé—´ï¼Œç„¶åä»ç­‰å¾…channelä¸­è·å–ç­‰å¾…channelä¸­çš„æ¥å—è€…ï¼Œå¦‚æœå–åˆ°æ¥æ”¶è€…ï¼Œåˆ™å°†å¯¹è±¡ç›´æ¥ä¼ é€’ç»™æ¥å—è€…ï¼Œç„¶åå°†æ¥å—è€…æ‰€åœ¨çš„goæ”¾å…¥Pæ‰€åœ¨çš„å¯è¿è¡ŒGé˜Ÿåˆ—,å‘é€è¿‡ç¨‹å®Œæˆï¼Œå¦‚æœæœªå–åˆ°æ¥æ”¶è€…ï¼Œåˆ™å°†å‘é€è€…enqueueåˆ°å‘é€channelï¼Œå‘é€è€…è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæœ‰ç¼“å†²çš„channeléœ€è¦å…ˆåˆ¤æ–­channelç¼“å†²æ˜¯å¦è¿˜æœ‰ç©ºé—´ï¼Œå¦‚æœç¼“å†²ç©ºé—´å·²æ»¡ï¼Œåˆ™å°†å‘é€è€…enqueueåˆ°å‘é€channelï¼Œå‘é€è€…è¿›å…¥é˜»å¡çŠ¶æ€å¦‚æœç¼“å†²ç©ºé—´æœªæ»¡ï¼Œåˆ™å°†å…ƒç´ copyåˆ°ç¼“å†²ä¸­ï¼Œè¿™æ—¶å‘é€è€…å°±ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæœ€åå°è¯•å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªæ¥å—è€…ã€‚</p>
<p>æ¥æ”¶channel<br>å‘channelä¸­æ¥æ”¶æ•°æ®æ—¶åœ¨runtimeåŒ…ä¸­å¯¹åº”çš„æ˜¯ï¼Œä»¥ä¸‹æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">func chanrecv(t *chantype, c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) &#123;</div><div class="line">	// raceenabled: don&apos;t need to check ep, as it is always on the stack</div><div class="line">	// or is new memory allocated by reflect.</div><div class="line"></div><div class="line">	if debugChan &#123;</div><div class="line">		print(&quot;chanrecv: chan=&quot;, c, &quot;\n&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c == nil &#123;</div><div class="line">		if !block &#123;</div><div class="line">			return</div><div class="line">		&#125;</div><div class="line">		gopark(nil, nil, &quot;chan receive (nil chan)&quot;, traceEvGoStop, 2)</div><div class="line">		throw(&quot;unreachable&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// Fast path: check for failed non-blocking operation without acquiring the lock.</div><div class="line">	//</div><div class="line">	// After observing that the channel is not ready for receiving, we observe that the</div><div class="line">	// channel is not closed. Each of these observations is a single word-sized read</div><div class="line">	// (first c.sendq.first or c.qcount, and second c.closed).</div><div class="line">	// Because a channel cannot be reopened, the later observation of the channel</div><div class="line">	// being not closed implies that it was also not closed at the moment of the</div><div class="line">	// first observation. We behave as if we observed the channel at that moment</div><div class="line">	// and report that the receive cannot proceed.</div><div class="line">	//</div><div class="line">	// The order of operations is important here: reversing the operations can lead to</div><div class="line">	// incorrect behavior when racing with a close.</div><div class="line">	if !block &amp;&amp; (c.dataqsiz == 0 &amp;&amp; c.sendq.first == nil ||</div><div class="line">		c.dataqsiz &gt; 0 &amp;&amp; atomic.Loaduint(&amp;c.qcount) == 0) &amp;&amp;</div><div class="line">		atomic.Load(&amp;c.closed) == 0 &#123;</div><div class="line">		return</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	var t0 int64</div><div class="line">	if blockprofilerate &gt; 0 &#123;</div><div class="line">		t0 = cputicks()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lock(&amp;c.lock)</div><div class="line"></div><div class="line">	if c.closed != 0 &amp;&amp; c.qcount == 0 &#123;</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(unsafe.Pointer(c))</div><div class="line">		&#125;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		if ep != nil &#123;</div><div class="line">			typedmemclr(c.elemtype, ep)</div><div class="line">		&#125;</div><div class="line">		return true, false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if sg := c.sendq.dequeue(); sg != nil &#123;</div><div class="line">		// Found a waiting sender. If buffer is size 0, receive value</div><div class="line">		// directly from sender. Otherwise, receive from head of queue</div><div class="line">		// and add sender&apos;s value to the tail of the queue (both map to</div><div class="line">		// the same buffer slot because the queue is full).</div><div class="line">		recv(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;)</div><div class="line">		return true, true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c.qcount &gt; 0 &#123;</div><div class="line">		// Receive directly from queue</div><div class="line">		qp := chanbuf(c, c.recvx)</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(qp)</div><div class="line">			racerelease(qp)</div><div class="line">		&#125;</div><div class="line">		if ep != nil &#123;</div><div class="line">			typedmemmove(c.elemtype, ep, qp)</div><div class="line">		&#125;</div><div class="line">		typedmemclr(c.elemtype, qp)</div><div class="line">		c.recvx++</div><div class="line">		if c.recvx == c.dataqsiz &#123;</div><div class="line">			c.recvx = 0</div><div class="line">		&#125;</div><div class="line">		c.qcount--</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return true, true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if !block &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return false, false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// no sender available: block on this channel.</div><div class="line">	gp := getg()</div><div class="line">	mysg := acquireSudog()</div><div class="line">	mysg.releasetime = 0</div><div class="line">	if t0 != 0 &#123;</div><div class="line">		mysg.releasetime = -1</div><div class="line">	&#125;</div><div class="line">	// No stack splits between assigning elem and enqueuing mysg</div><div class="line">	// on gp.waiting where copystack can find it.</div><div class="line">	mysg.elem = ep</div><div class="line">	mysg.waitlink = nil</div><div class="line">	gp.waiting = mysg</div><div class="line">	mysg.g = gp</div><div class="line">	mysg.selectdone = nil</div><div class="line">	mysg.c = c</div><div class="line">	gp.param = nil</div><div class="line">	c.recvq.enqueue(mysg)</div><div class="line">	goparkunlock(&amp;c.lock, &quot;chan receive&quot;, traceEvGoBlockRecv, 3)</div><div class="line"></div><div class="line">	// someone woke us up</div><div class="line">	if mysg != gp.waiting &#123;</div><div class="line">		throw(&quot;G waiting list is corrupted&quot;)</div><div class="line">	&#125;</div><div class="line">	gp.waiting = nil</div><div class="line">	if mysg.releasetime &gt; 0 &#123;</div><div class="line">		blockevent(mysg.releasetime-t0, 2)</div><div class="line">	&#125;</div><div class="line">	closed := gp.param == nil</div><div class="line">	gp.param = nil</div><div class="line">	mysg.c = nil</div><div class="line">	releaseSudog(mysg)</div><div class="line">	return true, !closed</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ¥æ”¶channelä¸å‘é€ç±»ä¼¼é¦–å…ˆä¹Ÿæ˜¯åˆ¤æ–­channelçš„ç±»å‹ï¼Œç„¶åå¦‚æœæ˜¯æœ‰ç¼“å†²çš„channelå°±åˆ¤æ–­ç¼“å†²ä¸­æ˜¯å¦æœ‰å…ƒç´ ï¼Œæ¥ç€ä»channelä¸­è·å–æ¥å—è€…ï¼Œå¦‚æœå–åˆ°ï¼Œåˆ™ç›´æ¥ä»æ¥æ”¶è€…è·å–å…ƒç´ ï¼Œå¹¶å”¤é†’å‘é€è€…ï¼Œæœ¬æ¬¡æ¥æ”¶è¿‡ç¨‹å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å–åˆ°æ¥æ”¶è€…ï¼Œé˜»å¡å½“å‰çš„goroutineå¹¶ç­‰å¾…å‘é€è€…å”¤é†’ï¼Œå¦‚æœæ˜¯æ‹¥æœ‰ç¼“å†²çš„channeléœ€è¦å…ˆåˆ¤æ–­ç¼“å†²ä¸­æ˜¯å¦æœ‰å…ƒç´ ï¼Œç¼“å†²ä¸ºç©ºæ—¶ï¼Œé˜»å¡å½“å‰goroutineå¹¶ç­‰å¾…å‘é€è€…å”¤é†’ï¼Œç¼“å†²å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºç¼“å†²ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå°è¯•å”¤é†’channelä¸­çš„ä¸€ä¸ªå‘é€è€…(è¿™ç¯‡æ–‡ç« æš‚å±ä¸´æ—¶ç‰ˆæœ¬ï¼Œæœ‰äº›è¯éœ€è¦æ–Ÿé…Œï¼Œä¸ä¹…ä¼šæ›´æ–°ã€‚ã€‚ã€‚)</p>
<p>æ¥ä¸‹æ¥æˆ‘ä¼šå‘è¡¨selectçš„ç»“æ„å…ˆè¯´ä¸ªé¢„å‘Šã€‚ã€‚ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">select &#123;</div><div class="line">       case c &lt;- v:</div><div class="line">              ... foo</div><div class="line">       default:</div><div class="line">              ... bar</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>//selectçš„caseå’Œdefault ç¼–è¯‘å™¨æœ€ç»ˆä¼šç¼–è¯‘æˆif else<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if selectnbsend(c, v) &#123;</div><div class="line">       ... foo</div><div class="line">&#125; else &#123;</div><div class="line">       ... bar</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æœªæ¥å‡ å¤©æˆ‘ä¼šå®Œæˆselectçš„å…·ä½“å®ç°ã€‚ã€‚ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> Go è¯­è¨€ </tag>
            
            <tag> golang æœ€ä½³å®è·µ </tag>
            
            <tag> æŠ€æœ¯åŸç† </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[interfaceå¼•å‘çš„äº‹ä»¶çœŸç›¸]]></title>
      <url>/2017/10/26/interface%E5%BC%95%E5%8F%91%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%9C%9F%E7%9B%B8/</url>
      <content type="html"><![CDATA[<p><img src="http://oyft9mgwt.bkt.clouddn.com/interface%E5%BC%95%E5%8F%91%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%9C%9F%E7%9B%B8.jpg" alt=""><br>(PS:ä¸“æ æ‰€æœ‰çš„ä»£ç éƒ½æ˜¯åŸºäºgo version go1.8 darwin/amd64)</p>
<p>æµåŠ¨çš„æ°´æ²¡æœ‰å½¢çŠ¶ï¼Œæ¼‚æµçš„é£æ‰¾ä¸åˆ°è¸ªè¿¹ï¼Œä¸€åˆ‡ä»£ç éƒ½äº†ç„¶äºå¿ƒï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œæ€»æ˜¯æœ‰ä¸€ç§æ€ç»´å®šå¼é™ªä¼´å·¦å³ï¼Œåœ¨å¯¹äº‹ç‰©åšåˆ¤æ–­çš„æ—¶å€™ï¼Œå¾€å¾€è¿™ç§æ€ç»´å®šå¼ä¼šå¾€æ­£å‘æˆ–åå‘åšæ¨åŠ¨ä½œç”¨ï¼Œåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­å¦‚æœä¸å°å¿ƒå¿½ç•¥ï¼Œå¾€å¾€å°±æ˜¯åŸ‹ä¸‹äº†é™·é˜±ï¼Œä»¥ä¸‹ä»£ç æ˜¯å¤§å¤šæ•°æ–°æ‰‹ä¼šé‡åˆ°çš„å‘ï¼Œ<br><a id="more"></a></p>
<p>package main</p>
<p>import (<br>    â€œfmtâ€<br>)</p>
<p>type People interface {<br>    Name() string<br>}<br>type Student struct{ name string }</p>
<p>func (stu *Student) Name() string {<br>    return stu.name<br>}</p>
<p>func getPeople() People {<br>    var stu *Student<br>    return stu<br>}</p>
<p>func main() {<br>    if getPeople() == nil {<br>        fmt.Println(â€œAAAAAâ€)<br>    } else {<br>        fmt.Println(â€œBBBBBâ€)<br>    }<br>}<br>ä¸Šé¢çš„ä»£ç è¾“å‡ºä»€ä¹ˆé‚£ï¼Ÿæœ‰äº›äººä¼šè®¤ä¸ºæ‰“å°AAAAAï¼Œå› ä¸ºä»–ä»¬ä¼šè®¤ä¸ºgetPeopleæ–¹æ³•é‡Œé¢stuæ˜¯nil æ‰€ä»¥è¿”å›çš„å°±æ˜¯nilï¼Œè¿™æ ·æƒ³å°±å¤§é”™ç‰¹é”™ï¼Œå› ä¸ºè™½ç„¶è¿”å›çš„stuæ˜¯nil ä½†æ˜¯å‡½æ•°è¿”å›æ—¶Peopleæ¥å£çš„ç»“æ„çš„æœ¬èº«å¹¶ä¸æ˜¯nilï¼Œåœ¨æˆ‘ä»¬ä¸äº†è§£interfaceå†…éƒ¨ç»“æ„ä¹‹å‰è¯·å¾€ä¸‹çœ‹ã€‚</p>
<p>ä¸ºä»€ä¹ˆæˆ‘ä¼šé€‰æ‹©å»å†™ä¸€ä¸ªå…³äºinterfaceçš„æ–‡ç« é‚£ï¼Œæˆ‘è®¤ä¸ºä»–åœ¨goè¯­è¨€é‡Œé¢æœ‰è¿™éå¸¸é‡è¦çš„åœ°ä½ï¼Œä»…æ¬¡äºgoroutineå’Œchannelçš„åœ°ä½ï¼Œæˆ‘åœ¨æœªæ¥è§¦goä¹‹å‰ä¸€ç›´ä»äº‹äºc#çš„å¼€å‘ï¼Œæ¥å£å¯¹æˆ‘æ¥è¯´å°±æ˜¯ä¸åŒç»„ä»¶ä¹‹é—´çš„å¥‘çº¦ï¼Œå¯¹è¿™ä¸ªå¥‘çº¦å¼ºåˆ¶ä½ å¿…é¡»å»ç»§æ‰¿æ¥å£ï¼Œè€Œgoè¯­è¨€çš„è®¾è®¡å°±éå¸¸è½»å·§ï¼Œåªè¦å®ç°äº†æ¥å£æ‰€è¦æ±‚çš„æ‰€æœ‰å‡½æ•°å³å¯ï¼Œgoä¸­çš„æ¥å£åˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯ç©ºçš„æ¥å£ç±»ä¼¼è¿™æ ·ï¼š</p>
<p>var in interface{}<br>ä¾‹å¤–ä¸€ç§æ˜¯éç©ºçš„æ¥å£å³åœ¨æ¥å£å†…éƒ¨å£°æ˜äº†ä¸€äº›æ–¹æ³•ï¼š</p>
<p>type People interface {<br>    Name() string<br>}<br>æ¥ä¸‹æ¥æˆ‘å°±æ ¹æ®ä¸Šé¢çš„ä¾‹å­æ¥å¯¹æ¯”ä¸€ä¸‹ç©ºæ¥å£å’Œéç©ºæ¥å£å†…éƒ¨ç»“æ„</p>
<p>type eface struct {          //ç©ºæ¥å£<br>    _type <em>_type         //ç±»å‹ä¿¡æ¯<br>    data  unsafe.Pointer //æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ(goè¯­è¨€ä¸­ç‰¹æ®Šçš„æŒ‡é’ˆç±»å‹unsafe.Pointerç±»ä¼¼äºcè¯­è¨€ä¸­çš„void</em>)<br>}<br>type iface struct {          //å¸¦æœ‰æ–¹æ³•çš„æ¥å£<br>    tab  <em>itab           //å­˜å‚¨typeä¿¡æ¯è¿˜æœ‰ç»“æ„å®ç°æ–¹æ³•çš„é›†åˆ<br>    data unsafe.Pointer  //æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ(goè¯­è¨€ä¸­ç‰¹æ®Šçš„æŒ‡é’ˆç±»å‹unsafe.Pointerç±»ä¼¼äºcè¯­è¨€ä¸­çš„void</em>)<br>}<br>efaceåŒ…å«ä¸€ä¸ªç±»å‹ä¿¡æ¯ï¼Œå¯ä»¥ä¸ºreflectæä¾›å¸®åŠ©</p>
<p>type _type struct {<br>    size       uintptr  //ç±»å‹å¤§å°<br>    ptrdata    uintptr  //å‰ç¼€æŒæœ‰æ‰€æœ‰æŒ‡é’ˆçš„å†…å­˜å¤§å°<br>    hash       uint32   //æ•°æ®hashå€¼<br>    tflag      tflag<br>    align      uint8    //å¯¹é½<br>    fieldalign uint8    //åµŒå…¥ç»“æ„ä½“æ—¶çš„å¯¹é½<br>    kind       uint8    //kind æœ‰äº›æšä¸¾å€¼kindç­‰äº0æ˜¯æ— æ•ˆçš„<br>    alg        <em>typeAlg //å‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œç±»å‹å®ç°çš„æ‰€æœ‰æ–¹æ³•<br>    gcdata    </em>byte<br>    str       nameOff<br>    ptrToThis typeOff<br>}<br>ifaceæ¯”eface ä¸­é—´å¤šäº†ä¸€å±‚itabç»“æ„</p>
<p>type itab struct {<br>    inter  <em>interfacetype  //æ¥å£ç±»å‹<br>    _type  </em>_type          //ç»“æ„ç±»å‹<br>    link   *itab<br>    bad    int32<br>    inhash int32<br>    fun    [1]uintptr      //å¯å˜å¤§å° æ–¹æ³•é›†åˆ<br>}<br>itab å­˜å‚¨_typeä¿¡æ¯å’Œ[]funæ–¹æ³•é›†ï¼Œä»ä¸Šé¢çš„ç»“æ„æˆ‘ä»¬å°±å¯å¾—å‡ºï¼Œå› ä¸ºdataæŒ‡å‘äº†nil å¹¶ä¸ä»£è¡¨interface æ˜¯nilï¼Œæ‰€ä»¥è¿”å›å€¼å¹¶ä¸ä¸ºç©ºï¼Œè¿™é‡Œçš„fun(æ–¹æ³•é›†)å®šä¹‰äº†æ¥å£çš„æ¥æ”¶è§„åˆ™ï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­éœ€è¦éªŒè¯æ˜¯å¦å®ç°æ¥å£ï¼Œæ¥å£çš„å…·ä½“ç»†èŠ‚ä½ å¯ä»¥é˜…è¯»Go Data Structures: Interfaces </p>
<p>æ¥ä¸‹æ¥æ˜¯ç¬¬äºŒä¸ªä¾‹å­ï¼š</p>
<p>package main</p>
<p>import (<br>    â€œfmtâ€<br>)</p>
<p>type People interface {<br>    Speak(string) string<br>}</p>
<p>type Stduent struct{}</p>
<p>func (stu *Stduent) Speak(think string) (talk string) {<br>    if think == â€œbitchâ€ {<br>        talk = â€œYou are a good boyâ€<br>    } else {<br>        talk = â€œhiâ€<br>    }<br>    return<br>}</p>
<p>func main() {<br>    var peo People = Stduent{}<br>    think := â€œbitchâ€<br>    fmt.Println(peo.Speak(think))<br>}<br>ä¸Šé¢çš„ä»£ç æ˜¯ä¸èƒ½ç¼–è¯‘è¿‡å»çš„ï¼Œä¼šæç¤ºæ²¡æœ‰å®ç°è¯¥æ¥å£ï¼Œåªè¦æˆ‘ä»¬æŠŠvar peo People = Stduent{}ä¿®æ”¹ä¸ºvar peo People = &amp;Stduent{}å°±å¯ä»¥äº†ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é™åˆ¶ï¼Œ</p>
<p>è¿™æ˜¯å› ä¸ºæ¥å£å®šä¹‰ä¸è§„å®šå®ç°è€…æ˜¯å¦åº”è¯¥ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è¿˜æ˜¯å€¼æ¥æ”¶å®ç°æ¥å£ã€‚å½“ä½¿ç”¨æ¥å£æ—¶ï¼Œä¸èƒ½ä¿è¯åº•å±‚ç±»å‹æ˜¯å€¼è¿˜æ˜¯æŒ‡é’ˆã€‚æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æŒ‡é’ˆæ¥å—æ–¹æ³•ï¼Œä¿®æ”¹ä¸ºå€¼æ¥å—æ–¹æ³•:</p>
<p>func (stu Stduent) Speak(think string) (talk string) {<br>    if think == â€œbitchâ€ {<br>        talk = â€œYou are a good boyâ€<br>    } else {<br>        talk = â€œhiâ€<br>    }<br>    return<br>}<br>æˆ‘ä»¬å†æ¬¡è¿è¡Œæ‰“å°:</p>
<p>You are a good boy<br>é€šè¿‡ä¸Šé¢æµ‹è¯•æˆ‘ä»¬å¾—å‡ºä¸€ä¸ªç»“è®ºä½¿ç”¨å€¼ä¼ é€’æ–¹æ³•ï¼Œæ¥å£èµ‹å€¼ä½¿ç”¨var peo People = Stduent{}æˆ–è€…var peo People = &amp;Stduent{}ï¼Œå¦‚æœä½¿ç”¨æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’,åˆ™åªèƒ½ä½¿ç”¨var peo People = &amp;Stduent{}ï¼Œæ­£æ˜¯ç”±äºinterfaceçš„çµæ´»æ€§ï¼Œå¯ä»¥ä½¿ç”¨golangå®ç°å¤šæ€çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´è¦å¯¹interfaceå¤šåšæ·±å…¥äº†è§£ã€‚(æœ¬æ–‡æœªæ¥å¯èƒ½ä¼šåšä¸€äº›ç»†å¾®çš„è°ƒæ•´)</p>
]]></content>
      
        
        <tags>
            
            <tag> Go è¯­è¨€ </tag>
            
            <tag> golang æœ€ä½³å®è·µ </tag>
            
            <tag> ç¼–ç¨‹ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[golangå®ç°epollä»£ç è§£æ]]></title>
      <url>/2017/10/25/golang%E5%AE%9E%E7%8E%B0epoll%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>åœ¨æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å…ˆè®²ä¸ªæ•…äº‹ï¼Œæˆ‘æœ‰ä¸ªæœ‹å‹ä»¥å‰æ˜¯javaç¨‹åºå‘˜ï¼Œåæ¥è½¬è¿‡æ¥åšgoï¼Œå½“æˆ‘é—®ä»–ä¸ºä»€ä¹ˆé€‰æ‹©goçš„æ—¶å€™ï¼Œä»–è·Ÿæˆ‘è¯´ï¼Œå› ä¸ºå†™goå°±æ²¡äººè¯´ä»–å†™çš„ä»£ç lowäº† ğŸ˜„ğŸ˜„ğŸ˜„ è¿™åªæ˜¯ä¸ªæ®µå­ä¸è¦å½“çœŸã€‚ã€‚ã€‚<br>å¥½å›å½’æ­£é¢˜ golang çš„ç½‘ç»œè½®å¾ªå™¨æ˜¯å¦‚ä½•å®ç°çš„é‚£ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹ golang çš„ç½‘ç»œè½®å¾ªå™¨æ˜¯åšä»€ä¹ˆçš„ï¼Œä½ çš„goç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªMå»è·‘æˆ‘ä»¬çš„ç³»ç»Ÿç›‘æµ‹ä»»åŠ¡ä»£ç å¦‚ä¸‹(ä¸“æ ä¸‹é¢çš„æ‰€æœ‰æ–‡ç« éƒ½æ˜¯ä»¥go 1.8ç‰ˆæœ¬ä¸ºå‡†):</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemstack(func() &#123;</div><div class="line">     newm(sysmon, nil)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>sysmonæ–¹æ³•å°±æ˜¯æˆ‘ä»¬è¯´çš„ç›‘æ§ä»»åŠ¡ï¼Œå®ƒæ²¡æœ‰å’Œä»»ä½•çš„P(é€»è¾‘å¤„ç†å™¨)è¿›è¡Œç»‘å®šï¼Œè€Œæ˜¯é€šè¿‡è‡ªèº«æ”¹å˜ç¡çœ æ—¶é—´å’Œæ—¶é—´é—´éš”æ¥ä¸€ç›´å¾ªç¯ä¸‹å»(ä»£ç ä½äºruntime/proc.go)ã€‚ golangä¸­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦éƒ½è¢«è®¾ç½®æˆéé˜»å¡çš„ï¼ŒæŸä¸ªgoroutineè¿›è¡Œç½‘ç»œioæ“ä½œï¼Œè¯»æˆ–è€…å†™æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ­¤åˆ»ç½‘ç»œioè¿˜æ²¡å‡†å¤‡å¥½ï¼Œåˆ™è¿™ä¸ªgoroutineä¼šè¢«æ”¾åˆ°ç³»ç»Ÿçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªgoroutineå¤±å»äº†è¿è¡Œæƒï¼Œä½†å¹¶ä¸æ˜¯çœŸæ­£çš„æ•´ä¸ªç³»ç»Ÿâ€œé˜»å¡â€äºç³»ç»Ÿè°ƒç”¨ï¼Œåå°è¿˜æœ‰ä¸€ä¸ªpollerä¼šä¸åœåœ°è¿›è¡Œpollï¼Œæ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦éƒ½è¢«æ·»åŠ åˆ°äº†è¿™ä¸ªpollerä¸­çš„ï¼Œå½“æŸä¸ªæ—¶åˆ»ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½äº†ï¼Œpollerå°±ä¼šå”¤é†’ä¹‹å‰å› å®ƒè€Œé˜»å¡çš„goroutineï¼Œäºæ˜¯goroutineé‡æ–°è¿è¡Œèµ·æ¥ã€‚<br>ç½‘ç»œè½®å¾ªå™¨å°±åœ¨è¿™ä¸ªforå¾ªç¯ä¹‹ä¸­ï¼Œä»epoll çš„epollwait æ¥å£è·å–å‡†å¤‡å°±ç»ªçš„ *g (ç»“æ„æŒ‡é’ˆ) æœ€åæ³¨å…¥åˆ°å½“å‰è°ƒåº¦å™¨ä¸‹çš„å¯è·å–çš„Gé˜Ÿåˆ—ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">atomic.Cas64(&amp;sched.lastpoll, uint64(lastpoll), uint64(now))</div><div class="line">gp := netpoll(false)</div><div class="line">if gp != nil &#123;</div><div class="line">       injectglist(gp)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„netpollå°±æ˜¯ä»Šå¤©çš„ä¸»è§’ï¼Œä»¥ä¸‹æ˜¯è¿½è¸ªå™¨çš„éƒ¨åˆ†ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">for &#123;</div><div class="line">		if idle == 0 &#123; //20usåå¼€å§‹ç¡çœ </div><div class="line">			delay = 20</div><div class="line">		&#125; else if idle &gt; 50 &#123; //ç¡çœ 1æ¯«ç§’åç¿»å€</div><div class="line">			delay *= 2</div><div class="line">		&#125;</div><div class="line">		if delay &gt; 10*1000 &#123; //10ms</div><div class="line">			delay = 10 * 1000</div><div class="line">		&#125;</div><div class="line">                //ä»¥ä¸Šæ˜¯è°ƒæ•´æ—¶é—´é—´éš”</div><div class="line">		usleep(delay)</div><div class="line">                //ç¡çœ è‹¥å¹²æ¯«ç§’å,åˆ¤æ–­æ˜¯å¦è¿›è¡Œè°ƒåº¦è¿½è¸ªï¼Œ</div><div class="line">                //å¹¶ä¸” æ˜¯å¦è¿›è¡Œåƒåœ¾å›æ”¶æˆ–æ‰€æœ‰çš„Péƒ½å¤„åœ¨ç©ºé—²çŠ¶æ€</div><div class="line">		if debug.schedtrace &lt;= 0 &amp;&amp; (sched.gcwaiting != 0 || atomic.Load(&amp;sched.npidle) == uint32(gomaxprocs)) &#123;</div><div class="line">			lock(&amp;sched.lock)</div><div class="line">			if atomic.Load(&amp;sched.gcwaiting) != 0 || atomic.Load(&amp;sched.npidle) == uint32(gomaxprocs) &#123;</div><div class="line">				atomic.Store(&amp;sched.sysmonwait, 1)</div><div class="line">				unlock(&amp;sched.lock)</div><div class="line">				//å”¤é†’ä»»åŠ¡</div><div class="line">				maxsleep := forcegcperiod / 2</div><div class="line">				if scavengelimit &lt; forcegcperiod &#123;</div><div class="line">					maxsleep = scavengelimit / 2</div><div class="line">				&#125;</div><div class="line">				notetsleep(&amp;sched.sysmonnote, maxsleep)</div><div class="line">				lock(&amp;sched.lock)</div><div class="line"></div><div class="line">				atomic.Store(&amp;sched.sysmonwait, 0)</div><div class="line">				noteclear(&amp;sched.sysmonnote)</div><div class="line">                                //é‡ç½®æ—¶é—´é—´éš”</div><div class="line">				idle = 0</div><div class="line">				delay = 20</div><div class="line">			&#125;</div><div class="line">			unlock(&amp;sched.lock)</div><div class="line">		&#125;</div><div class="line">		//è·ç¦»ä¸Šæ¬¡æ‹‰å»æ˜¯å¦è¶…è¿‡10ms</div><div class="line">		lastpoll := int64(atomic.Load64(&amp;sched.lastpoll))</div><div class="line">		now := nanotime()</div><div class="line">		unixnow := unixnanotime()</div><div class="line">                //åˆ¤æ–­è·å–æœ€åä¸€æ¬¡ä»ç½‘ç»œI/Oè½®å¾ªæŸ¥æ‰¾Gçš„æ—¶é—´</div><div class="line">		if lastpoll != 0 &amp;&amp; lastpoll+10*1000*1000 &lt; now &#123;</div><div class="line">                        //æ›´æ–°æœ€åä¸€æ¬¡æŸ¥è¯¢Gæ—¶é—´ï¼Œä¸ºäº†ä¸‹ä¸€æ¬¡åšåˆ¤æ–­ã€‚</div><div class="line">			atomic.Cas64(&amp;sched.lastpoll, uint64(lastpoll), uint64(now))</div><div class="line">                        //è¿™è¡Œä»£ç æ˜¯ä»Šå¤©çš„ä¸»è§’ï¼Œä»ç½‘ç»œI/O(æˆ‘å–œæ¬¢å«ç½‘ç»œè½®è¯¢å™¨)</div><div class="line">                        //æŸ¥æ‰¾å·²ç»å°±ç»ªçš„Gï¼Œæ³¨æ„ä¸æ˜¯é˜»å¡çš„</div><div class="line">			gp := netpoll(false)</div><div class="line"></div><div class="line">			if gp != nil &#123;</div><div class="line">				incidlelocked(-1)</div><div class="line">                                //æ‰¾åˆ°åæ³¨å…¥åˆ°è°ƒåº¦å™¨ä¸‹é¢çš„å¯è·å–çš„Gé˜Ÿåˆ—</div><div class="line">				injectglist(gp)</div><div class="line">				incidlelocked(1)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		// å†æ¬¡å¤ºå–Pã€ é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨</div><div class="line">		// å†æ¬¡å¤ºå–é•¿æ—¶é—´è¿è¡Œçš„G</div><div class="line">		...</div><div class="line">                ...</div><div class="line">                ...</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ç®€å•çš„ä»‹ç»äº†è¿½è¸ªå™¨çš„å¤§æ¦‚æµç¨‹ï¼Œæ¥ä¸‹æ¥æœ‰è¯·æˆ‘ä»¬çš„ä¸»è§’show time.</p>
<p>ç½‘ç»œè½®è½®å¾ªå™¨ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆçš„å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„socketæè¿°ç¬¦,è¿™é‡Œæœ‰linuxä¸‹éé˜»å¡ioåº“ epoll - çŸ¥ä¹ä¸“æ çš„å…·ä½“ä»‹ç»ã€‚ã€‚ã€‚</p>
<p>æˆ‘å…ˆåˆ—å‡ºgolangä¸‰ä¸ªå°è£…çš„ç³»ç»Ÿè°ƒç”¨</p>
<h2 id="1ã€åˆ›å»ºepoll"><a href="#1ã€åˆ›å»ºepoll" class="headerlink" title="1ã€åˆ›å»ºepoll"></a>1ã€åˆ›å»ºepoll</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">func epollcreate(size int32) int32</div><div class="line">func epollcreate1(flags int32) int32</div><div class="line"></div><div class="line">TEXT runtimeÂ·epollcreate1(SB),NOSPLIT,$0</div><div class="line">	MOVL    $329, AX</div><div class="line">	MOVL	flags+0(FP), BX</div><div class="line">	INVOKE_SYSCALL</div><div class="line">	MOVL	AX, ret+4(FP)</div><div class="line">	RET</div><div class="line">epollcreate() å¯ä»¥åˆ›å»ºä¸€ä¸ªepollå®ä¾‹ã€‚åœ¨linux å†…æ ¸ç‰ˆæœ¬å¤§äº2.6.8 åï¼Œè¿™ä¸ªsize å‚æ•°å°±è¢«å¼ƒç”¨äº†ï¼Œä½†æ˜¯ä¼ å…¥çš„å€¼å¿…é¡»å¤§äº0ã€‚è¿™é‡Œå¼•ç”¨äº†äº’è”ç½‘ä¸Šçš„ä¸€å¥è¯</div></pre></td></tr></table></figure>
<p>åœ¨ epollcreate() çš„æœ€åˆå®ç°ç‰ˆæœ¬æ—¶ï¼Œ sizeå‚æ•°çš„ä½œç”¨æ˜¯åˆ›å»ºepollå®ä¾‹æ—¶å€™å‘Šè¯‰å†…æ ¸éœ€è¦ä½¿ç”¨å¤šå°‘ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å†…æ ¸ä¼šä½¿ç”¨ size çš„å¤§å°å»ç”³è¯·å¯¹åº”çš„å†…å­˜(å¦‚æœåœ¨ä½¿ç”¨çš„æ—¶å€™è¶…è¿‡äº†ç»™å®šçš„sizeï¼Œ å†…æ ¸ä¼šç”³è¯·æ›´å¤šçš„ç©ºé—´)ã€‚ç°åœ¨ï¼Œè¿™ä¸ªsizeå‚æ•°ä¸å†ä½¿ç”¨äº†ï¼ˆå†…æ ¸ä¼šåŠ¨æ€çš„ç”³è¯·éœ€è¦çš„å†…å­˜ï¼‰ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªsizeå¿…é¡»è¦å¤§äº0ï¼Œä¸ºäº†å…¼å®¹æ—§ç‰ˆçš„linux å†…æ ¸çš„ä»£ç ã€‚<br>epollcreate1() å¦‚æœflagsçš„å€¼æ˜¯0ï¼Œepollcreate1()ç­‰åŒäºepollcreate()é™¤äº†è¿‡æ—¶çš„sizeè¢«é—å¼ƒäº†ã€‚å½“ç„¶flasgå¯ä»¥ä½¿ç”¨_EPOLL_CLOEXEC = 0x80000ã€‚</p>
<h2 id="2ã€è®¾ç½®epolläº‹ä»¶"><a href="#2ã€è®¾ç½®epolläº‹ä»¶" class="headerlink" title="2ã€è®¾ç½®epolläº‹ä»¶"></a>2ã€è®¾ç½®epolläº‹ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">func epollctl(epfd, op, fd int32, ev *epollevent) int32</div><div class="line"></div><div class="line">// sys_linux_386.s</div><div class="line">TEXT runtimeÂ·epollctl(SB),NOSPLIT,$0</div><div class="line">	MOVL	$255, AX</div><div class="line">	MOVL	epfd+0(FP), BX</div><div class="line">	MOVL	op+4(FP), CX</div><div class="line">	MOVL	fd+8(FP), DX</div><div class="line">	MOVL	ev+12(FP), SI</div><div class="line">	INVOKE_SYSCALL</div><div class="line">	MOVL	AX, ret+16(FP)</div><div class="line">	RET</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå‚æ•°epfdæŒ‡å‘epollçš„å®ä¾‹ï¼Œop æ·»åŠ äº‹ä»¶çš„ç±»å‹ fdæ˜¯è¦æ³¨å†Œçš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ï¼Œev æ˜¯å…³è”æŒ‡å®šçš„æè¿°ç¬¦</p>
<p>op çš„æšä¸¾å€¼:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">_EPOLL_CTL_ADD = 0x1 //åœ¨epfdä¸­æ³¨å†ŒæŒ‡å®šçš„fdæ–‡ä»¶æè¿°ç¬¦å¹¶èƒ½æŠŠeventå’Œfdå…³è”èµ·æ¥ã€‚</div><div class="line">_EPOLL_CTL_MOD = 0x3 //æ”¹å˜ fdå’Œevetnä¹‹é—´çš„è”ç³»ã€‚</div><div class="line">_EPOLL_CTL_DEL = 0x2 //ä»æŒ‡å®šçš„epfdä¸­åˆ é™¤fdæ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­eventæ˜¯è¢«å¿½ç•¥çš„ï¼Œå¹¶ä¸”ä¸ºå¯ä»¥ç­‰äºnilã€‚</div></pre></td></tr></table></figure>
<p>event ç»“æ„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">type epollevent struct &#123;</div><div class="line">	events uint32</div><div class="line">	data   [8]byte // to match amd64</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3ã€ç­‰å¾…epolläº‹ä»¶"><a href="#3ã€ç­‰å¾…epolläº‹ä»¶" class="headerlink" title="3ã€ç­‰å¾…epolläº‹ä»¶"></a>3ã€ç­‰å¾…epolläº‹ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">func epollwait(epfd int32, ev *epollevent, nev, timeout int32) int32</div><div class="line"></div><div class="line">TEXT runtimeÂ·epollwait(SB),NOSPLIT,$0</div><div class="line">	MOVL	$256, AX</div><div class="line">	MOVL	epfd+0(FP), BX</div><div class="line">	MOVL	ev+4(FP), CX</div><div class="line">	MOVL	nev+8(FP), DX</div><div class="line">	MOVL	timeout+12(FP), SI</div><div class="line">	INVOKE_SYSCALL</div><div class="line">	MOVL	AX, ret+16(FP)</div><div class="line">	RET</div></pre></td></tr></table></figure>
<p>epollwait è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æ¥è¿”å›epfdä¸­çš„å°±ç»ªçš„Gã€‚eventsæŒ‡å‘è°ƒç”¨è€…å¯ä»¥ä½¿ç”¨çš„äº‹ä»¶çš„å†…å­˜åŒºåŸŸã€‚nevå‘ŠçŸ¥å†…æ ¸æœ‰å¤šå°‘ä¸ªeventsï¼Œå¿…é¡»è¦å¤§äº0ï¼Œtimeout æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚</p>
<p>golang ç½‘ç»œè½®å¾ªå™¨çš„ä»£ç å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">func netpoll(block bool) *g &#123;</div><div class="line">	if epfd == -1 &#123;</div><div class="line">		return nil</div><div class="line">	&#125;</div><div class="line">	waitms := int32(-1)</div><div class="line">	if !block &#123;</div><div class="line">		waitms = 0</div><div class="line">	&#125;</div><div class="line">	var events [128]epollevent</div><div class="line">retry:</div><div class="line">	n := epollwait(epfd, &amp;events[0], int32(len(events)), waitms)</div><div class="line">	if n &lt; 0 &#123;</div><div class="line">		if n != -_EINTR &#123;</div><div class="line">			println(&quot;runtime: epollwait on fd&quot;, epfd, &quot;failed with&quot;, -n)</div><div class="line">			throw(&quot;epollwait failed&quot;)</div><div class="line">		&#125;</div><div class="line">		goto retry</div><div class="line">	&#125;</div><div class="line">	var gp guintptr</div><div class="line">	for i := int32(0); i &lt; n; i++ &#123;</div><div class="line">		ev := &amp;events[i]</div><div class="line">		if ev.events == 0 &#123;</div><div class="line">			continue</div><div class="line">		&#125;</div><div class="line">		var mode int32</div><div class="line">		if ev.events&amp;(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) != 0 &#123;</div><div class="line">			mode += &apos;r&apos;</div><div class="line">		&#125;</div><div class="line">		if ev.events&amp;(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) != 0 &#123;</div><div class="line">			mode += &apos;w&apos;</div><div class="line">		&#125;</div><div class="line">		if mode != 0 &#123;</div><div class="line">			pd := *(**pollDesc)(unsafe.Pointer(&amp;ev.data))</div><div class="line"></div><div class="line">			netpollready(&amp;gp, pd, mode)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	if block &amp;&amp; gp == 0 &#123;</div><div class="line">		goto retry</div><div class="line">	&#125;</div><div class="line">	return gp.ptr()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> epoll </tag>
            
            <tag> IOå¤šè·¯å¤ç”¨ </tag>
            
            <tag> Goè¯­è¨€ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linuxä¸‹éé˜»å¡ioåº“ epoll]]></title>
      <url>/2017/10/25/linux%E4%B8%8B%E9%9D%9E%E9%98%BB%E5%A1%9Eio%E5%BA%93-epoll/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç”¨ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥è§£é‡Š"><a href="#ä¸€ã€ç”¨ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥è§£é‡Š" class="headerlink" title="ä¸€ã€ç”¨ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥è§£é‡Š."></a>ä¸€ã€ç”¨ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥è§£é‡Š.</h2><p>å‡è®¾ä½ åœ¨å¤§å­¦ä¸­è¯»ä¹¦,è¦ç­‰å¾…ä¸€ä¸ªæœ‹å‹æ¥è®¿,è€Œè¿™ä¸ªæœ‹å‹åªçŸ¥é“ä½ åœ¨Aå·æ¥¼,ä½†æ˜¯ä¸çŸ¥é“ä½ å…·ä½“ä½åœ¨å“ªé‡Œ,äºæ˜¯ä½ ä»¬çº¦å¥½äº†åœ¨Aå·æ¥¼é—¨å£è§é¢.<br>å¦‚æœä½ ä½¿ç”¨çš„é˜»å¡IOæ¨¡å‹æ¥å¤„ç†è¿™ä¸ªé—®é¢˜,é‚£ä¹ˆä½ å°±åªèƒ½ä¸€ç›´å®ˆå€™åœ¨Aå·æ¥¼é—¨å£ç­‰å¾…æœ‹å‹çš„åˆ°æ¥,åœ¨è¿™æ®µæ—¶é—´é‡Œä½ ä¸èƒ½åšåˆ«çš„äº‹æƒ…,ä¸éš¾çŸ¥é“,è¿™ç§æ–¹å¼çš„æ•ˆç‡æ˜¯ä½ä¸‹çš„.</p>
<p>è¿›ä¸€æ­¥è§£é‡Šselectå’Œepollæ¨¡å‹çš„å·®å¼‚.<br>selectç‰ˆå¤§å¦ˆåšçš„æ˜¯å¦‚ä¸‹çš„äº‹æƒ…:æ¯”å¦‚åŒå­¦ç”²çš„æœ‹å‹æ¥äº†,selectç‰ˆå¤§å¦ˆæ¯”è¾ƒç¬¨,å¥¹å¸¦ç€æœ‹å‹æŒ¨ä¸ªæˆ¿é—´è¿›è¡ŒæŸ¥è¯¢è°æ˜¯åŒå­¦ç”²,ä½ ç­‰çš„æœ‹å‹æ¥äº†,äºæ˜¯åœ¨å®é™…çš„ä»£ç ä¸­,selectç‰ˆå¤§å¦ˆåšçš„æ˜¯ä»¥ä¸‹çš„äº‹æƒ…:</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">int n = select(&amp;readset,NULL,NULL,100); </div><div class="line">for (int i = 0; n &gt; 0; ++i) &#123;</div><div class="line">     if (FD_ISSET(fdarray[i], &amp;readset)) &#123;</div><div class="line">         do_something(fdarray[i]); --n; </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>epollç‰ˆå¤§å¦ˆå°±æ¯”è¾ƒå…ˆè¿›äº†,å¥¹è®°ä¸‹äº†åŒå­¦ç”²çš„ä¿¡æ¯,æ¯”å¦‚è¯´ä»–çš„æˆ¿é—´å·,é‚£ä¹ˆç­‰åŒå­¦ç”²çš„æœ‹å‹åˆ°æ¥æ—¶,åªéœ€è¦å‘Šè¯‰è¯¥æœ‹å‹åŒå­¦ç”²åœ¨å“ªä¸ªæˆ¿é—´å³å¯,ä¸ç”¨è‡ªå·±äº²è‡ªå¸¦ç€äººæ»¡å¤§æ¥¼çš„æ‰¾äººäº†.äºæ˜¯epollç‰ˆå¤§å¦ˆåšçš„äº‹æƒ…å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç è¡¨ç¤º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">n = epoll_wait(epfd,events,20,500);</div><div class="line">for(i=0;i&lt;n;++i) &#123; </div><div class="line">    do_something(events[n]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨epollä¸­,å…³é”®çš„æ•°æ®ç»“æ„epoll_eventå®šä¹‰å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">typedef union epoll_data &#123;</div><div class="line">     void *ptr;</div><div class="line">     int fd; </div><div class="line">     __uint32_t u32;</div><div class="line">     __uint64_t u64; </div><div class="line">&#125;epoll_data_t; </div><div class="line"></div><div class="line">struct epoll_event &#123; </div><div class="line">    __uint32_t events; /* Epoll events */ </div><div class="line">    epoll_data_t data;/* User data variable */</div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°,epoll_dataæ˜¯ä¸€ä¸ªunionç»“æ„ä½“,å®ƒå°±æ˜¯epollç‰ˆå¤§å¦ˆç”¨äºä¿å­˜åŒå­¦ä¿¡æ¯çš„ç»“æ„ä½“,å®ƒå¯ä»¥ä¿å­˜å¾ˆå¤šç±»å‹çš„ä¿¡æ¯:<br>fd,æŒ‡é’ˆ,ç­‰ç­‰.æœ‰äº†è¿™ä¸ªç»“æ„ä½“,epollå¤§å¦ˆå¯ä»¥ä¸ç”¨å¹ç°ä¹‹åŠ›å°±å¯ä»¥å®šä½åˆ°åŒå­¦ç”².</p>
<p>åˆ«å°çœ‹äº†è¿™äº›æ•ˆç‡çš„æé«˜,åœ¨ä¸€ä¸ªå¤§è§„æ¨¡å¹¶å‘çš„æœåŠ¡å™¨ä¸­,è½®è¯¢IOæ˜¯æœ€è€—æ—¶é—´çš„æ“ä½œä¹‹ä¸€.å†å›åˆ°é‚£ä¸ªä¾‹å­ä¸­,å¦‚æœæ¯åˆ°æ¥ä¸€ä¸ªæœ‹å‹æ¥¼ç®¡å¤§å¦ˆéƒ½è¦å…¨æ¥¼çš„æŸ¥è¯¢åŒå­¦,é‚£ä¹ˆå¤„ç†çš„æ•ˆç‡å¿…ç„¶å°±ä½ä¸‹äº†,è¿‡ä¸ä¹…æ¥¼åº•å°±æœ‰ä¸å°‘çš„äººäº†.</p>
<p>å¯¹æ¯”æœ€æ—©ç»™å‡ºçš„é˜»å¡IOçš„å¤„ç†æ¨¡å‹, å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†å¤šè·¯å¤ç”¨IOä¹‹å, ç¨‹åºå¯ä»¥è‡ªç”±çš„è¿›è¡Œè‡ªå·±é™¤äº†IOæ“ä½œä¹‹å¤–çš„å·¥ä½œ, åªæœ‰åˆ°IOçŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ç”±å¤šè·¯å¤ç”¨IOè¿›è¡Œé€šçŸ¥, ç„¶åå†é‡‡å–ç›¸åº”çš„æ“ä½œ, è€Œä¸ç”¨ä¸€ç›´é˜»å¡ç­‰å¾…IOçŠ¶æ€å‘ç”Ÿå˜åŒ–äº†.</p>
<p>ä»ä¸Šé¢çš„åˆ†æä¹Ÿå¯ä»¥çœ‹å‡º,epollæ¯”selectçš„æé«˜å®é™…ä¸Šæ˜¯ä¸€ä¸ªç”¨ç©ºé—´æ¢æ—¶é—´æ€æƒ³çš„å…·ä½“åº”ç”¨.</p>
<h2 id="äºŒã€æ·±å…¥ç†è§£epollçš„å®ç°åŸç†ï¼šå¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°epollã€‚"><a href="#äºŒã€æ·±å…¥ç†è§£epollçš„å®ç°åŸç†ï¼šå¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°epollã€‚" class="headerlink" title="äºŒã€æ·±å…¥ç†è§£epollçš„å®ç°åŸç†ï¼šå¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°epollã€‚"></a>äºŒã€æ·±å…¥ç†è§£epollçš„å®ç°åŸç†ï¼šå¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°epollã€‚</h2><p>å¤§å®¶éƒ½æ˜ç™½epollæ˜¯ä¸€ç§IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆçš„å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„socketå¥æŸ„ï¼Œæ¯”èµ·ä»¥å‰çš„selectå’Œpollæ•ˆç‡é«˜å¤§å‘äº†ã€‚</p>
<p>æˆ‘ä»¬ç”¨èµ·epollæ¥éƒ½æ„Ÿè§‰æŒºçˆ½ï¼Œç¡®å®å¿«ï¼Œé‚£ä¹ˆï¼Œå®ƒåˆ°åº•ä¸ºä»€ä¹ˆå¯ä»¥é«˜é€Ÿå¤„ç†è¿™ä¹ˆå¤šå¹¶å‘è¿æ¥å‘¢ï¼Ÿ</p>
<p>å…ˆç®€å•å›é¡¾ä¸‹å¦‚ä½•ä½¿ç”¨Cåº“å°è£…çš„3ä¸ªepollç³»ç»Ÿè°ƒç”¨å§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int epoll_create(int size); </div><div class="line">int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); </div><div class="line">int epoll_wait(int epfd, struct epoll_event *events,int maxevents, int timeout);</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨èµ·æ¥å¾ˆæ¸…æ™°ï¼Œé¦–å…ˆè¦è°ƒç”¨epoll_createå»ºç«‹ä¸€ä¸ªepollå¯¹è±¡ã€‚å‚æ•°sizeæ˜¯å†…æ ¸ä¿è¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†çš„æœ€å¤§å¥æŸ„æ•°ï¼Œå¤šäºè¿™ä¸ªæœ€å¤§æ•°æ—¶å†…æ ¸å¯ä¸ä¿è¯æ•ˆæœã€‚<br>epoll_ctlå¯ä»¥æ“ä½œä¸Šé¢å»ºç«‹çš„epollï¼Œä¾‹å¦‚ï¼Œå°†åˆšå»ºç«‹çš„socketåŠ å…¥åˆ°epollä¸­è®©å…¶ç›‘æ§ï¼Œæˆ–è€…æŠŠ epollæ­£åœ¨ç›‘æ§çš„æŸä¸ªsocketå¥æŸ„ç§»å‡ºepollï¼Œä¸å†ç›‘æ§å®ƒç­‰ç­‰ã€‚</p>
<p>epoll_waitåœ¨è°ƒç”¨æ—¶ï¼Œåœ¨ç»™å®šçš„timeoutæ—¶é—´å†…ï¼Œå½“åœ¨ç›‘æ§çš„æ‰€æœ‰å¥æŸ„ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±è¿”å›ç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚<br>ä»ä¸Šé¢çš„è°ƒç”¨æ–¹å¼å°±å¯ä»¥çœ‹åˆ°epollæ¯”select/pollçš„ä¼˜è¶Šä¹‹å¤„ï¼š</p>
<p>å› ä¸ºåè€…æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¦ä¼ é€’ä½ æ‰€è¦ç›‘æ§çš„æ‰€æœ‰socketç»™select/pollç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ„å‘³ç€éœ€è¦å°†ç”¨æˆ·æ€çš„socketåˆ—è¡¨copyåˆ°å†…æ ¸æ€ï¼Œå¦‚æœä»¥ä¸‡è®¡çš„å¥æŸ„ä¼šå¯¼è‡´æ¯æ¬¡éƒ½è¦copyå‡ åå‡ ç™¾KBçš„å†…å­˜åˆ°å†…æ ¸æ€ï¼Œéå¸¸ä½æ•ˆã€‚</p>
<p>è€Œæˆ‘ä»¬è°ƒç”¨epoll_waitæ—¶å°±ç›¸å½“äºä»¥å¾€è°ƒç”¨select/pollï¼Œä½†æ˜¯è¿™æ—¶å´ä¸ç”¨ä¼ é€’socketå¥æŸ„ç»™å†…æ ¸ï¼Œå› ä¸ºå†…æ ¸å·²ç»åœ¨epoll_ctlä¸­æ‹¿åˆ°äº†è¦ç›‘æ§çš„å¥æŸ„åˆ—è¡¨ã€‚</p>
<p>æ‰€ä»¥ï¼Œå®é™…ä¸Šåœ¨ä½ è°ƒç”¨epoll_createåï¼Œå†…æ ¸å°±å·²ç»åœ¨å†…æ ¸æ€å¼€å§‹å‡†å¤‡å¸®ä½ å­˜å‚¨è¦ç›‘æ§çš„å¥æŸ„äº†ï¼Œæ¯æ¬¡è°ƒç”¨epoll_ctlåªæ˜¯åœ¨å¾€å†…æ ¸çš„æ•°æ®ç»“æ„é‡Œå¡å…¥æ–°çš„socketå¥æŸ„ã€‚</p>
<p>åœ¨å†…æ ¸é‡Œï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œepollå‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ä¸Šè¿°çš„è¢«ç›‘æ§socketã€‚</p>
<p>å½“ä½ è°ƒç”¨epoll_createæ—¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªè™šæ‹Ÿçš„epollæ–‡ä»¶ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªfileç»“ç‚¹ã€‚å½“ç„¶è¿™ä¸ªfileä¸æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå®ƒåªæœåŠ¡äºepollã€‚epollåœ¨è¢«å†…æ ¸åˆå§‹åŒ–æ—¶ï¼ˆæ“ä½œç³»ç»Ÿå¯åŠ¨ï¼‰ï¼ŒåŒæ—¶ä¼šå¼€è¾Ÿå‡ºepollè‡ªå·±çš„å†…æ ¸é«˜é€ŸcacheåŒºï¼Œç”¨äºå®‰ç½®æ¯ä¸€ä¸ªæˆ‘ä»¬æƒ³ç›‘æ§çš„socketï¼Œè¿™äº›socketä¼šä»¥çº¢é»‘æ ‘çš„å½¢å¼ä¿å­˜åœ¨å†…æ ¸cacheé‡Œï¼Œä»¥æ”¯æŒå¿«é€Ÿçš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ã€‚</p>
<p>è¿™ä¸ªå†…æ ¸é«˜é€ŸcacheåŒºï¼Œå°±æ˜¯å»ºç«‹è¿ç»­çš„ç‰©ç†å†…å­˜é¡µï¼Œç„¶ååœ¨ä¹‹ä¸Šå»ºç«‹slabå±‚ï¼Œç®€å•çš„è¯´ï¼Œå°±æ˜¯ç‰©ç†ä¸Šåˆ†é…å¥½ä½ æƒ³è¦çš„sizeçš„å†…å­˜å¯¹è±¡ï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½æ˜¯ä½¿ç”¨ç©ºé—²çš„å·²åˆ†é…å¥½çš„å¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">static int __init eventpoll_init(void) &#123; </div><div class="line">    ... ... </div><div class="line">    /* Allocates slab cache used to allocate &quot;struct epitem&quot; items */ </div><div class="line">    epi_cache = kmem_cache_create(&quot;eventpoll_epi&quot;, sizeof(struct  epitem),0,SLAB_HWCACHE_ALIGN| EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL); </div><div class="line">    /* Allocates slab cache used to allocate &quot;struct eppoll_entry&quot; */ </div><div class="line">    pwq_cache = kmem_cache_create(&quot;eventpoll_pwq&quot;, sizeof(struct eppoll_entry), 0, EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL); </div><div class="line">    ... ...</div></pre></td></tr></table></figure>
<p>epollçš„é«˜æ•ˆå°±åœ¨äºï¼Œå½“æˆ‘ä»¬è°ƒç”¨epoll_ctlå¾€é‡Œå¡å…¥ç™¾ä¸‡ä¸ªå¥æŸ„æ—¶ï¼Œepoll_waitä»ç„¶å¯ä»¥é£å¿«çš„è¿”å›ï¼Œå¹¶æœ‰æ•ˆçš„å°†å‘ç”Ÿäº‹ä»¶çš„å¥æŸ„ç»™æˆ‘ä»¬ç”¨æˆ·ã€‚</p>
<p>è¿™æ˜¯ç”±äºæˆ‘ä»¬åœ¨è°ƒç”¨epoll_createæ—¶ï¼Œå†…æ ¸é™¤äº†å¸®æˆ‘ä»¬åœ¨epollæ–‡ä»¶ç³»ç»Ÿé‡Œå»ºäº†ä¸ªfileç»“ç‚¹ï¼Œåœ¨å†…æ ¸cacheé‡Œå»ºäº†ä¸ªçº¢é»‘æ ‘ç”¨äºå­˜å‚¨ä»¥åepoll_ctlä¼ æ¥çš„socketå¤–ï¼Œè¿˜ä¼šå†å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œå½“epoll_waitè°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿè¿™ä¸ªlisté“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å³å¯ã€‚æœ‰æ•°æ®å°±è¿”å›ï¼Œæ²¡æœ‰æ•°æ®å°±sleepï¼Œç­‰åˆ°timeoutæ—¶é—´åˆ°åå³ä½¿é“¾è¡¨æ²¡æ•°æ®ä¹Ÿè¿”å›ã€‚æ‰€ä»¥ï¼Œepoll_waitéå¸¸é«˜æ•ˆã€‚</p>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªå‡†å¤‡å°±ç»ªlisté“¾è¡¨æ˜¯æ€ä¹ˆç»´æŠ¤çš„å‘¢ï¼Ÿå½“æˆ‘ä»¬æ‰§è¡Œepoll_ctlæ—¶ï¼Œé™¤äº†æŠŠsocketæ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚</p>
<p>æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†ã€‚<br>å¦‚æ­¤ï¼Œä¸€é¢—çº¢é»‘æ ‘ï¼Œä¸€å¼ å‡†å¤‡å°±ç»ªå¥æŸ„é“¾è¡¨ï¼Œå°‘é‡çš„å†…æ ¸cacheï¼Œå°±å¸®æˆ‘ä»¬è§£å†³äº†å¤§å¹¶å‘ä¸‹çš„socketå¤„ç†é—®é¢˜ã€‚</p>
<p>æ‰§è¡Œepoll_createæ—¶ï¼Œåˆ›å»ºäº†çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨ï¼Œæ‰§è¡Œepoll_ctlæ—¶ï¼Œå¦‚æœå¢åŠ socketå¥æŸ„ï¼Œåˆ™æ£€æŸ¥åœ¨çº¢é»‘æ ‘ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ç«‹å³è¿”å›ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°æ ‘å¹²ä¸Šï¼Œç„¶åå‘å†…æ ¸æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨äºå½“ä¸­æ–­äº‹ä»¶æ¥ä¸´æ—¶å‘å‡†å¤‡å°±ç»ªé“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚æ‰§è¡Œepoll_waitæ—¶ç«‹åˆ»è¿”å›å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œçš„æ•°æ®å³å¯ã€‚</p>
<p>æœ€åçœ‹çœ‹epollç‹¬æœ‰çš„ä¸¤ç§æ¨¡å¼LTå’ŒETã€‚æ— è®ºæ˜¯LTå’ŒETæ¨¡å¼ï¼Œéƒ½é€‚ç”¨äºä»¥ä¸Šæ‰€è¯´çš„æµç¨‹ã€‚</p>
<p>åŒºåˆ«æ˜¯ï¼ŒLTæ¨¡å¼ä¸‹ï¼Œåªè¦ä¸€ä¸ªå¥æŸ„ä¸Šçš„äº‹ä»¶ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œï¼Œä¼šåœ¨ä»¥åè°ƒç”¨epoll_waitæ—¶æ¬¡æ¬¡è¿”å›è¿™ä¸ªå¥æŸ„ï¼Œè€ŒETæ¨¡å¼ä»…åœ¨ç¬¬ä¸€æ¬¡è¿”å›ã€‚</p>
<p>è¿™ä»¶äº‹æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿå½“ä¸€ä¸ªsocketå¥æŸ„ä¸Šæœ‰äº‹ä»¶æ—¶ï¼Œå†…æ ¸ä¼šæŠŠè¯¥å¥æŸ„æ’å…¥ä¸Šé¢æ‰€è¯´çš„å‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œè¿™æ—¶æˆ‘ä»¬è°ƒç”¨epoll_waitï¼Œä¼šæŠŠå‡†å¤‡å°±ç»ªçš„socketæ‹·è´åˆ°ç”¨æˆ·æ€å†…å­˜ï¼Œç„¶åæ¸…ç©ºå‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œæœ€åï¼Œepoll_waitå¹²äº†ä»¶äº‹ï¼Œå°±æ˜¯æ£€æŸ¥è¿™äº›socketï¼Œå¦‚æœä¸æ˜¯ETæ¨¡å¼ï¼ˆå°±æ˜¯LTæ¨¡å¼çš„å¥æŸ„äº†ï¼‰ï¼Œå¹¶ä¸”è¿™äº›socketä¸Šç¡®å®æœ‰æœªå¤„ç†çš„äº‹ä»¶æ—¶ï¼ŒåˆæŠŠè¯¥å¥æŸ„æ”¾å›åˆ°åˆšåˆšæ¸…ç©ºçš„å‡†å¤‡å°±ç»ªé“¾è¡¨äº†ã€‚</p>
<p>æ‰€ä»¥ï¼ŒéETçš„å¥æŸ„ï¼Œåªè¦å®ƒä¸Šé¢è¿˜æœ‰äº‹ä»¶ï¼Œepoll_waitæ¯æ¬¡éƒ½ä¼šè¿”å›ã€‚è€ŒETæ¨¡å¼çš„å¥æŸ„ï¼Œé™¤éæœ‰æ–°ä¸­æ–­åˆ°ï¼Œå³ä½¿socketä¸Šçš„äº‹ä»¶æ²¡æœ‰å¤„ç†å®Œï¼Œä¹Ÿæ˜¯ä¸ä¼šæ¬¡æ¬¡ä»epoll_waitè¿”å›çš„ã€‚</p>
<h2 id="ä¸‰ã€æ‰©å±•é˜…è¯»ï¼ˆepollä¸ä¹‹å‰å…¶ä»–ç›¸å…³æŠ€æœ¯çš„æ¯”è¾ƒï¼‰ï¼š"><a href="#ä¸‰ã€æ‰©å±•é˜…è¯»ï¼ˆepollä¸ä¹‹å‰å…¶ä»–ç›¸å…³æŠ€æœ¯çš„æ¯”è¾ƒï¼‰ï¼š" class="headerlink" title="ä¸‰ã€æ‰©å±•é˜…è¯»ï¼ˆepollä¸ä¹‹å‰å…¶ä»–ç›¸å…³æŠ€æœ¯çš„æ¯”è¾ƒï¼‰ï¼š"></a>ä¸‰ã€æ‰©å±•é˜…è¯»ï¼ˆepollä¸ä¹‹å‰å…¶ä»–ç›¸å…³æŠ€æœ¯çš„æ¯”è¾ƒï¼‰ï¼š</h2><p>Linuxæä¾›äº†selectã€pollã€epollæ¥å£æ¥å®ç°IOå¤ç”¨ï¼Œä¸‰è€…çš„åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼Œæœ¬æ–‡ä»å‚æ•°ã€å®ç°ã€æ€§èƒ½ç­‰æ–¹é¢å¯¹ä¸‰è€…è¿›è¡Œå¯¹æ¯”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout); </div><div class="line">int poll(struct pollfd *fds, nfds_t nfds, int timeout);</div><div class="line">int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</div></pre></td></tr></table></figure>
<p>selectã€pollã€epoll_waitå‚æ•°åŠå®ç°å¯¹æ¯”</p>
<p>selectçš„ç¬¬ä¸€ä¸ªå‚æ•°nfdsä¸ºfdseté›†åˆä¸­æœ€å¤§æè¿°ç¬¦å€¼åŠ 1ï¼Œfdsetæ˜¯ä¸€ä¸ªä½æ•°ç»„ï¼Œå…¶å¤§å°é™åˆ¶ä¸º__FD_SETSIZEï¼ˆ1024ï¼‰ï¼Œä½æ•°ç»„çš„æ¯ä¸€ä½ä»£è¡¨å…¶å¯¹åº”çš„æè¿°ç¬¦æ˜¯å¦éœ€è¦è¢«æ£€æŸ¥ã€‚<br>selectçš„ç¬¬äºŒä¸‰å››ä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦å…³æ³¨è¯»ã€å†™ã€é”™è¯¯äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä½æ•°ç»„ï¼Œè¿™äº›å‚æ•°æ—¢æ˜¯è¾“å…¥å‚æ•°ä¹Ÿæ˜¯è¾“å‡ºå‚æ•°ï¼Œå¯èƒ½ä¼šè¢«å†…æ ¸ä¿®æ”¹ç”¨äºæ ‡ç¤ºå“ªäº›æè¿°ç¬¦ä¸Šå‘ç”Ÿäº†å…³æ³¨çš„äº‹ä»¶ã€‚<br>æ‰€ä»¥æ¯æ¬¡è°ƒç”¨selectå‰éƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–fdsetã€‚<br>timeoutå‚æ•°ä¸ºè¶…æ—¶æ—¶é—´ï¼Œè¯¥ç»“æ„ä¼šè¢«å†…æ ¸ä¿®æ”¹ï¼Œå…¶å€¼ä¸ºè¶…æ—¶å‰©ä½™çš„æ—¶é—´ã€‚<br>selectå¯¹åº”äºå†…æ ¸ä¸­çš„sys_selectè°ƒç”¨ï¼Œsys_selecté¦–å…ˆå°†ç¬¬äºŒä¸‰å››ä¸ªå‚æ•°æŒ‡å‘çš„fd_setæ‹·è´åˆ°å†…æ ¸ï¼Œç„¶åå¯¹æ¯ä¸ªè¢«SETçš„æè¿°ç¬¦è°ƒç”¨è¿›è¡Œpollï¼Œå¹¶è®°å½•åœ¨ä¸´æ—¶ç»“æœä¸­ï¼ˆfdsetï¼‰ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œselectä¼šå°†ä¸´æ—¶ç»“æœå†™åˆ°ç”¨æˆ·ç©ºé—´å¹¶è¿”å›ï¼›å½“è½®è¯¢ä¸€éåæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¦‚æœæŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼Œåˆ™selectä¼šç¡çœ åˆ°è¶…æ—¶ï¼Œç¡çœ ç»“æŸåå†è¿›è¡Œä¸€æ¬¡è½®è¯¢ï¼Œå¹¶å°†ä¸´æ—¶ç»“æœå†™åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè¿”å›ã€‚ selectè¿”å›åï¼Œéœ€è¦é€ä¸€æ£€æŸ¥å…³æ³¨çš„æè¿°ç¬¦æ˜¯å¦è¢«SETï¼ˆäº‹ä»¶æ˜¯å¦å‘ç”Ÿï¼‰ã€‚</p>
<p>pollä¸selectä¸åŒï¼Œé€šè¿‡ä¸€ä¸ªpollfdæ•°ç»„å‘å†…æ ¸ä¼ é€’éœ€è¦å…³æ³¨çš„äº‹ä»¶ï¼Œæ•…æ²¡æœ‰æè¿°ç¬¦ä¸ªæ•°çš„é™åˆ¶ï¼Œpollfdä¸­çš„eventså­—æ®µå’Œreventsåˆ†åˆ«ç”¨äºæ ‡ç¤ºå…³æ³¨çš„äº‹ä»¶å’Œå‘ç”Ÿçš„äº‹ä»¶ï¼Œæ•…pollfdæ•°ç»„åªéœ€è¦è¢«åˆå§‹åŒ–ä¸€æ¬¡ã€‚<br>pollçš„å®ç°æœºåˆ¶ä¸selectç±»ä¼¼ï¼Œå…¶å¯¹åº”å†…æ ¸ä¸­çš„sys_pollï¼Œåªä¸è¿‡pollå‘å†…æ ¸ä¼ é€’pollfdæ•°ç»„ï¼Œç„¶åå¯¹pollfdä¸­çš„æ¯ä¸ªæè¿°ç¬¦è¿›è¡Œpollï¼Œç›¸æ¯”å¤„ç†fdsetæ¥è¯´ï¼Œpollæ•ˆç‡æ›´é«˜ã€‚ pollè¿”å›åï¼Œéœ€è¦å¯¹pollfdä¸­çš„æ¯ä¸ªå…ƒç´ æ£€æŸ¥å…¶reventså€¼ï¼Œæ¥å¾—æŒ‡äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚</p>
<p>epollé€šè¿‡epoll_createåˆ›å»ºä¸€ä¸ªç”¨äºepollè½®è¯¢çš„æè¿°ç¬¦ï¼Œé€šè¿‡epoll_ctlæ·»åŠ /ä¿®æ”¹/åˆ é™¤äº‹ä»¶ï¼Œé€šè¿‡epoll_waitæ£€æŸ¥äº‹ä»¶ï¼Œepoll_waitçš„ç¬¬äºŒä¸ªå‚æ•°ç”¨äºå­˜æ”¾ç»“æœã€‚ epollä¸selectã€pollä¸åŒï¼Œé¦–å…ˆï¼Œå…¶ä¸ç”¨æ¯æ¬¡è°ƒç”¨éƒ½å‘å†…æ ¸æ‹·è´äº‹ä»¶æè¿°ä¿¡æ¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨åï¼Œäº‹ä»¶ä¿¡æ¯å°±ä¼šä¸å¯¹åº”çš„epollæè¿°ç¬¦å…³è”èµ·æ¥ã€‚å¦å¤–epollä¸æ˜¯é€šè¿‡è½®è¯¢ï¼Œè€Œæ˜¯é€šè¿‡åœ¨ç­‰å¾…çš„æè¿°ç¬¦ä¸Šæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå›è°ƒå‡½æ•°è´Ÿè´£æŠŠå‘ç”Ÿçš„äº‹ä»¶å­˜å‚¨åœ¨å°±ç»ªäº‹ä»¶é“¾è¡¨ä¸­ï¼Œæœ€åå†™åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
]]></content>
      
        
        <tags>
            
            <tag> epoll </tag>
            
            <tag> IOå¤šè·¯å¤ç”¨ </tag>
            
            <tag> Goè¯­è¨€ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢]]></title>
      <url>/2017/10/25/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/</url>
      <content type="html"><![CDATA[<p>#è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢</p>
<p>æ¨èä¸€ä¸‹æˆ‘çš„ä¸“æ : <a href="https://zhuanlan.zhihu.com/goroutine" target="_blank" rel="external">golangæ•°æ®ç»“æ„å†…éƒ¨å®ç°</a></p>
]]></content>
      
        
    </entry>
    
  
  
</search>
