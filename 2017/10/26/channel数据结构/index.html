<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title> channel数据结构 · 诺唯 </title>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="诺唯">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name= "format-detection" content="telephone=no" />
<meta name="keywords" content="nlvi, Nlvi" />


    <meta name="subtitle" content="Noaway">


    <meta name="description" content="诺唯,noaway">



    <meta name="keywords" content="Go 语言, golang 最佳实践, 技术原理, Nlvi" />

<link rel="stylesheet" href="/style/style.css">
<script src="/script/jquery.min.js"></script>
<script>
    var CONFIG = {
        title: "诺唯",
        author: "王阳",
        lightbox: true,
        animate: true
    }
</script>



    <link rel="stylesheet" href="/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">









    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</head>
<body>
    <div class="progress">
    <div class="progress-inner"></div>
</div>
    <div class="body">
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
    <div class="tagcloud-inner">
        <a href="/tags/Go-语言/" style="font-size: 14px;">Go 语言</a> <a href="/tags/Go语言/" style="font-size: 14px;">Go语言</a> <a href="/tags/IO多路复用/" style="font-size: 14px;">IO多路复用</a> <a href="/tags/epoll/" style="font-size: 14px;">epoll</a> <a href="/tags/golang-最佳实践/" style="font-size: 14px;">golang 最佳实践</a> <a href="/tags/技术原理/" style="font-size: 14px;">技术原理</a> <a href="/tags/编程/" style="font-size: 14px;">编程</a>
    </div>
</div>
    <header class="header" id="header">
    <div class="title syuanpi tvIn">
    <div class="table">
        <div class="connect">
            <div class="connect-inner">
                <span><a href="/">诺唯</a></span>
                
                    <span id="subtitle">Noaway</span>
                
            </div>
        </div>
    </div>
</div>
    <nav class="main-nav syuanpi tvIn">
<div class="table">

    <ul class="menu">
        
        <li class="menu-item">
            <a href="javascript:;" id="search">
                <span>搜索</span>
                
                    <span class="menu-item-label">search</span>
                
            </a>
        </li>
        
        
        
            <li class="menu-item">
                <a href="/">
                    <span>文章</span>
                    
                        <span class="menu-item-label">article</span>
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/archives">
                    <span>归档</span>
                    
                        <span class="menu-item-label">archives</span>
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="javascript:;" id="tags">
                    <span>标签</span>
                    
                        <span class="menu-item-label">tags</span>
                    
                </a>
            </li>
        
        
        
            <li class="menu-item">
                <a href="/about">
                    <span>关于</span>
                    
                        <span class="menu-item-label">about</span>
                    
                </a>
            </li>
        
        
    </ul>

</div>
</nav>
</header>
<div class="mobile-header">
    <div class="mobile-header-body">
        <div class="mobile-header-list">
            
            
                <div class="mobile-nav-item">
                    <a href="/">
                        <span>文章</span>
                        
                            <span class="menu-item-label">article</span>
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/archives">
                        <span>归档</span>
                        
                            <span class="menu-item-label">archives</span>
                        
                    </a>
                </div>
            
            
            
                <div class="mobile-nav-item inner-cloud">
                    <div class="mobile-nav-tag">
                        <a href="javascript:;" id="mobile-tags">
                            <span>标签</span>
                            
                                <span class="menu-item-label">tags</span>
                            
                        </a>
                    </div>
                    <div class="mobile-nav-tagcloud">
                        <div class="mobile-tagcloud-inner">
                            <a href="/tags/Go-语言/" style="font-size: 14px;">Go 语言</a> <a href="/tags/Go语言/" style="font-size: 14px;">Go语言</a> <a href="/tags/IO多路复用/" style="font-size: 14px;">IO多路复用</a> <a href="/tags/epoll/" style="font-size: 14px;">epoll</a> <a href="/tags/golang-最佳实践/" style="font-size: 14px;">golang 最佳实践</a> <a href="/tags/技术原理/" style="font-size: 14px;">技术原理</a> <a href="/tags/编程/" style="font-size: 14px;">编程</a>
                        </div>
                    </div>
                </div>
            
            
            
                <div class="mobile-nav-item">
                    <a href="/about">
                        <span>关于</span>
                        
                            <span class="menu-item-label">about</span>
                        
                    </a>
                </div>
            
            
        </div>
    </div>
    <div class="mobile-header-nav">
        <div class="mobile-header-item" id="mobile-left">
            <div class="header-menu-item">
                <span class="header-menu-line"></span>
            </div>
        </div>
        <h1 class="mobile-header-title">
            <a href="/">诺唯</a>
        </h1>
        <div class="mobile-header-item"></div>
    </div>
</div>

    <div class="container">
        <main class="main" id="main">
            
    
    <article class="post">
        <header class="post-header">
            <div class="post-time syuanpi riseIn-light back-1">
                <span>2017年10月26日</span>
                
            </div>
            <h1 class="post-title syuanpi riseIn-light back-2">
            
                channel数据结构
            
            </h1>
            
                
                    <div class="post-tags syuanpi riseIn-light back-3">
                    
                        <a href="/tags/Go-语言/">Go 语言</a>
                    
                        <a href="/tags/golang-最佳实践/">golang 最佳实践</a>
                    
                        <a href="/tags/技术原理/">技术原理</a>
                    
                    </div>
                
            
        </header>
        <div class="post-content syuanpi riseIn-light back-3">
            
                <p><img src="http://oyft9mgwt.bkt.clouddn.com/channel%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<p>channel是go语言的一大特色，使用原子函数还是使用互斥锁都不如使用channel来的简单，go语言中的channel可以作为函数参数传递和返回值返回，通过发送和接受数据在goroutine之间同步(在学习和使用go语言的时候，我们应该牢记，go语言中所有的结构都是值拷贝的)<br>本文不对channel使用作讲解，直接上酸(dai)菜(ma):<br><a id="more"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">type hchan struct &#123;</div><div class="line">	qcount   uint           //队列数据总的数据数量</div><div class="line">	dataqsiz uint           //环形队列的数据大小 </div><div class="line">	buf      unsafe.Pointer //指向dataqsiz元素类型大小的数组</div><div class="line">	elemsize uint16</div><div class="line">	closed   uint32</div><div class="line">	elemtype *_type // 元素类型</div><div class="line">	sendx    uint   // 发送数据时的游标</div><div class="line">	recvx    uint   // 接收数据时的游标</div><div class="line">	recvq    waitq  // 接收而阻塞的等待队列</div><div class="line">	sendq    waitq  // 发送而阻塞的等待队列</div><div class="line">        lock mutex      // 保护hchan所有字段的锁</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>hchan 是chan的结构体，在hchan结构中qcount和elemsize指定队列的容量和使用量，dataqsiz队列的大小，整个hchan结构体只记录了队列大小相关的值，带有缓冲区的chan需要make的时候指定，我们简单的看一下chan的make方法是如何分配缓冲区的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">func makechan(t *chantype, size int64) *hchan &#123;</div><div class="line">	elem := t.elem</div><div class="line">	</div><div class="line">        ...</div><div class="line">        ...</div><div class="line"></div><div class="line">	var c *hchan</div><div class="line">	if elem.kind&amp;kindNoPointers != 0 || size == 0 &#123;</div><div class="line">		c = (*hchan)(mallocgc(hchanSize+uintptr(size)*elem.size, nil, true))</div><div class="line">		if size &gt; 0 &amp;&amp; elem.size != 0 &#123;</div><div class="line">			c.buf = add(unsafe.Pointer(c), hchanSize)</div><div class="line">		&#125; else &#123;</div><div class="line">			c.buf = unsafe.Pointer(c)</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		c = new(hchan)</div><div class="line">		c.buf = newarray(elem, int(size))</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>makechan 将hchan初始化0值之后并判断size如果是有缓冲区的chan则紧挨着hchan结构体中分配size大小的 “_type” 类型的数组。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">type waitq struct &#123;</div><div class="line">	first *sudog</div><div class="line">	last  *sudog</div><div class="line">&#125;</div><div class="line">type sudog struct &#123;</div><div class="line">	g          *g</div><div class="line">	selectdone *uint32 </div><div class="line">	next       *sudog</div><div class="line">	prev       *sudog</div><div class="line">	elem       unsafe.Pointer </div><div class="line"></div><div class="line">	acquiretime int64</div><div class="line">	releasetime int64</div><div class="line">	ticket      uint32</div><div class="line">	waitlink    *sudog // g.waiting list</div><div class="line">	c           *hchan // channel</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>g和elem分别存储goroutine的数据</p>
<p>发送channel<br>向channel中写数据时在runtime包中对应的是，以下方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">func chansend(t *chantype, c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool &#123;</div><div class="line">	if raceenabled &#123;</div><div class="line">		raceReadObjectPC(t.elem, ep, callerpc, funcPC(chansend))</div><div class="line">	&#125;</div><div class="line">	if msanenabled &#123;</div><div class="line">		msanread(ep, t.elem.size)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c == nil &#123;</div><div class="line">		if !block &#123;</div><div class="line">			return false</div><div class="line">		&#125;</div><div class="line">		gopark(nil, nil, &quot;chan send (nil chan)&quot;, traceEvGoStop, 2)</div><div class="line">		throw(&quot;unreachable&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if debugChan &#123;</div><div class="line">		print(&quot;chansend: chan=&quot;, c, &quot;\n&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if raceenabled &#123;</div><div class="line">		racereadpc(unsafe.Pointer(c), callerpc, funcPC(chansend))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	</div><div class="line">	if !block &amp;&amp; c.closed == 0 &amp;&amp; ((c.dataqsiz == 0 &amp;&amp; c.recvq.first == nil) ||</div><div class="line">		(c.dataqsiz &gt; 0 &amp;&amp; c.qcount == c.dataqsiz)) &#123;</div><div class="line">		return false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	var t0 int64</div><div class="line">	if blockprofilerate &gt; 0 &#123;</div><div class="line">		t0 = cputicks()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lock(&amp;c.lock)</div><div class="line"></div><div class="line">	if c.closed != 0 &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		panic(plainError(&quot;send on closed channel&quot;))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if sg := c.recvq.dequeue(); sg != nil &#123;</div><div class="line">		send(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;)</div><div class="line">		return true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c.qcount &lt; c.dataqsiz &#123;</div><div class="line">		qp := chanbuf(c, c.sendx)</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(qp)</div><div class="line">			racerelease(qp)</div><div class="line">		&#125;</div><div class="line">		typedmemmove(c.elemtype, qp, ep)</div><div class="line">		c.sendx++</div><div class="line">		if c.sendx == c.dataqsiz &#123;</div><div class="line">			c.sendx = 0</div><div class="line">		&#125;</div><div class="line">		c.qcount++</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if !block &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	gp := getg()</div><div class="line">	mysg := acquireSudog()</div><div class="line">	mysg.releasetime = 0</div><div class="line">	if t0 != 0 &#123;</div><div class="line">		mysg.releasetime = -1</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	mysg.elem = ep</div><div class="line">	mysg.waitlink = nil</div><div class="line">	mysg.g = gp</div><div class="line">	mysg.selectdone = nil</div><div class="line">	mysg.c = c</div><div class="line">	gp.waiting = mysg</div><div class="line">	gp.param = nil</div><div class="line">	c.sendq.enqueue(mysg)</div><div class="line">	goparkunlock(&amp;c.lock, &quot;chan send&quot;, traceEvGoBlockSend, 3)</div><div class="line"></div><div class="line">	</div><div class="line">	if mysg != gp.waiting &#123;</div><div class="line">		throw(&quot;G waiting list is corrupted&quot;)</div><div class="line">	&#125;</div><div class="line">	gp.waiting = nil</div><div class="line">	if gp.param == nil &#123;</div><div class="line">		if c.closed == 0 &#123;</div><div class="line">			throw(&quot;chansend: spurious wakeup&quot;)</div><div class="line">		&#125;</div><div class="line">		panic(plainError(&quot;send on closed channel&quot;))</div><div class="line">	&#125;</div><div class="line">	gp.param = nil</div><div class="line">	if mysg.releasetime &gt; 0 &#123;</div><div class="line">		blockevent(mysg.releasetime-t0, 2)</div><div class="line">	&#125;</div><div class="line">	mysg.c = nil</div><div class="line">	releaseSudog(mysg)</div><div class="line">	return true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>发送数据时先判断channel类型，如果有缓冲区，判断channel是否还有空间，然后从等待channel中获取等待channel中的接受者，如果取到接收者，则将对象直接传递给接受者，然后将接受者所在的go放入P所在的可运行G队列,发送过程完成，如果未取到接收者，则将发送者enqueue到发送channel，发送者进入阻塞状态，有缓冲的channel需要先判断channel缓冲是否还有空间，如果缓冲空间已满，则将发送者enqueue到发送channel，发送者进入阻塞状态如果缓冲空间未满，则将元素copy到缓冲中，这时发送者就不会进入阻塞状态，最后尝试唤醒等待队列中的一个接受者。</p>
<p>接收channel<br>向channel中接收数据时在runtime包中对应的是，以下方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">func chanrecv(t *chantype, c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) &#123;</div><div class="line">	// raceenabled: don&apos;t need to check ep, as it is always on the stack</div><div class="line">	// or is new memory allocated by reflect.</div><div class="line"></div><div class="line">	if debugChan &#123;</div><div class="line">		print(&quot;chanrecv: chan=&quot;, c, &quot;\n&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c == nil &#123;</div><div class="line">		if !block &#123;</div><div class="line">			return</div><div class="line">		&#125;</div><div class="line">		gopark(nil, nil, &quot;chan receive (nil chan)&quot;, traceEvGoStop, 2)</div><div class="line">		throw(&quot;unreachable&quot;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// Fast path: check for failed non-blocking operation without acquiring the lock.</div><div class="line">	//</div><div class="line">	// After observing that the channel is not ready for receiving, we observe that the</div><div class="line">	// channel is not closed. Each of these observations is a single word-sized read</div><div class="line">	// (first c.sendq.first or c.qcount, and second c.closed).</div><div class="line">	// Because a channel cannot be reopened, the later observation of the channel</div><div class="line">	// being not closed implies that it was also not closed at the moment of the</div><div class="line">	// first observation. We behave as if we observed the channel at that moment</div><div class="line">	// and report that the receive cannot proceed.</div><div class="line">	//</div><div class="line">	// The order of operations is important here: reversing the operations can lead to</div><div class="line">	// incorrect behavior when racing with a close.</div><div class="line">	if !block &amp;&amp; (c.dataqsiz == 0 &amp;&amp; c.sendq.first == nil ||</div><div class="line">		c.dataqsiz &gt; 0 &amp;&amp; atomic.Loaduint(&amp;c.qcount) == 0) &amp;&amp;</div><div class="line">		atomic.Load(&amp;c.closed) == 0 &#123;</div><div class="line">		return</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	var t0 int64</div><div class="line">	if blockprofilerate &gt; 0 &#123;</div><div class="line">		t0 = cputicks()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	lock(&amp;c.lock)</div><div class="line"></div><div class="line">	if c.closed != 0 &amp;&amp; c.qcount == 0 &#123;</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(unsafe.Pointer(c))</div><div class="line">		&#125;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		if ep != nil &#123;</div><div class="line">			typedmemclr(c.elemtype, ep)</div><div class="line">		&#125;</div><div class="line">		return true, false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if sg := c.sendq.dequeue(); sg != nil &#123;</div><div class="line">		// Found a waiting sender. If buffer is size 0, receive value</div><div class="line">		// directly from sender. Otherwise, receive from head of queue</div><div class="line">		// and add sender&apos;s value to the tail of the queue (both map to</div><div class="line">		// the same buffer slot because the queue is full).</div><div class="line">		recv(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;)</div><div class="line">		return true, true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if c.qcount &gt; 0 &#123;</div><div class="line">		// Receive directly from queue</div><div class="line">		qp := chanbuf(c, c.recvx)</div><div class="line">		if raceenabled &#123;</div><div class="line">			raceacquire(qp)</div><div class="line">			racerelease(qp)</div><div class="line">		&#125;</div><div class="line">		if ep != nil &#123;</div><div class="line">			typedmemmove(c.elemtype, ep, qp)</div><div class="line">		&#125;</div><div class="line">		typedmemclr(c.elemtype, qp)</div><div class="line">		c.recvx++</div><div class="line">		if c.recvx == c.dataqsiz &#123;</div><div class="line">			c.recvx = 0</div><div class="line">		&#125;</div><div class="line">		c.qcount--</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return true, true</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if !block &#123;</div><div class="line">		unlock(&amp;c.lock)</div><div class="line">		return false, false</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// no sender available: block on this channel.</div><div class="line">	gp := getg()</div><div class="line">	mysg := acquireSudog()</div><div class="line">	mysg.releasetime = 0</div><div class="line">	if t0 != 0 &#123;</div><div class="line">		mysg.releasetime = -1</div><div class="line">	&#125;</div><div class="line">	// No stack splits between assigning elem and enqueuing mysg</div><div class="line">	// on gp.waiting where copystack can find it.</div><div class="line">	mysg.elem = ep</div><div class="line">	mysg.waitlink = nil</div><div class="line">	gp.waiting = mysg</div><div class="line">	mysg.g = gp</div><div class="line">	mysg.selectdone = nil</div><div class="line">	mysg.c = c</div><div class="line">	gp.param = nil</div><div class="line">	c.recvq.enqueue(mysg)</div><div class="line">	goparkunlock(&amp;c.lock, &quot;chan receive&quot;, traceEvGoBlockRecv, 3)</div><div class="line"></div><div class="line">	// someone woke us up</div><div class="line">	if mysg != gp.waiting &#123;</div><div class="line">		throw(&quot;G waiting list is corrupted&quot;)</div><div class="line">	&#125;</div><div class="line">	gp.waiting = nil</div><div class="line">	if mysg.releasetime &gt; 0 &#123;</div><div class="line">		blockevent(mysg.releasetime-t0, 2)</div><div class="line">	&#125;</div><div class="line">	closed := gp.param == nil</div><div class="line">	gp.param = nil</div><div class="line">	mysg.c = nil</div><div class="line">	releaseSudog(mysg)</div><div class="line">	return true, !closed</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接收channel与发送类似首先也是判断channel的类型，然后如果是有缓冲的channel就判断缓冲中是否有元素，接着从channel中获取接受者，如果取到，则直接从接收者获取元素，并唤醒发送者，本次接收过程完成，如果没有取到接收者，阻塞当前的goroutine并等待发送者唤醒，如果是拥有缓冲的channel需要先判断缓冲中是否有元素，缓冲为空时，阻塞当前goroutine并等待发送者唤醒，缓冲如果不为空，则取出缓冲中的第一个元素，然后尝试唤醒channel中的一个发送者(这篇文章暂属临时版本，有些话需要斟酌，不久会更新。。。)</p>
<p>接下来我会发表select的结构先说个预告。。。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">select &#123;</div><div class="line">       case c &lt;- v:</div><div class="line">              ... foo</div><div class="line">       default:</div><div class="line">              ... bar</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>//select的case和default 编译器最终会编译成if else<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if selectnbsend(c, v) &#123;</div><div class="line">       ... foo</div><div class="line">&#125; else &#123;</div><div class="line">       ... bar</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>未来几天我会完成select的具体实现。。。</p>

            
        
        </div>
        
            
            
        
    </article>
    
        
    <nav class="article-page">
        
        
            <a href="/2017/10/26/interface引发的事件真相/" id="art-right" class="art-left">
                <span class="prev-title"> 
                    <i class="iconfont icon-left"></i>interface引发的事件真相
                </span>
            </a>
        
    </nav>

        
    <i id="com-switch" class="iconfont icon-more jumping-in long infinite" style="font-size:24px;display:block;text-align:center;transform:rotate(180deg);"></i>
    <div class="post-comments" id="post-comments" style="display: block;margin: auto 16px;">
        
        
        
        
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://blog-noaway-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            


    </div>



    


        </main>
        <footer class="footer syuanpi fadeIn" id="footer">
    <hr>
    <div class="footer-wrapper">
        <div class="left">
            <div class="contact-icon">
    
    
    
    
    
    
    
    
        
        
        
        
            <a href="https://www.zhihu.com/people/noaway" class="iconfont icon-zhihu" title="zhihu"></a>
        
        
        
        
    
        
            <a href="https://github.com/noaway" class="iconfont icon-github" title="github"></a>
        
        
        
        
        
        
        
    
</div>
        </div>
        <div class="right">
            <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2016 ~ 2017</span>
        <span>❤</span>
        <span>王阳</span>
    </div>
    
    
    <div class="visit_count">
        <i class="iconfont icon-visit"></i>
        <span id="busuanzi_value_site_uv"></span>
        <i class="iconfont icon-people"></i>
        <span id="busuanzi_value_site_pv"></span>
    </div>
    
</div>
        </div>
    </div>
</footer>
    </div>
    <script src="/script/nlvi.js"></script>
<script src="/script/search.js"></script>

    <script src="/lightbox/js/lightbox.min.js"></script>

<script>
$(document).ready(function(){
    document.body.addEventListener('touchstart', function () {});
    $('.progress').hide();
    $('.body').show();
    Nlvi.tagcloud();
    Nlvi.mobileHeader();
    Nlvi.back2top();
    Nlvi.smoothScroll();
    Nlvi.onView();
    Nlvi.showToc();
    Nlvi.showComments();
    Nlvi.showReward();
    Nlvi.picPos();

    !CONFIG.animate && Nlvi.offAnimate();
    CONFIG.lightbox && Nlvi.onPicBox();
})
</script>
    </div>
    
        
    <div class="post-toc">
        <span class="title">文章目录</span>
        <div class="toc-inner syuanpi back-1 fallIn-light">
            <li class="title-link"><a href="javascript:;" class="toTop">channel数据结构</a></li>
            
        </div>
    </div>

    
    <div class="backtop syuanpi dead toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>
    
    <div class="search" id="search">
        <div class="mask" id="mask"></div>
        <div class="search-wrapper syuanpi">
            <h1 id="search-header" class="syuanpi">搜索一下？</h1>
            <div class="input">
                <input type="text" id="local-search-input" results="0" name="">
            </div>
            <div id="local-search-result"></div>
        </div>
    </div>
    <script>
    var GREETING = {
        morning: "当我们探索时，就要发现到真理",
        noon: "人的天职在于勇于探索真理。",
        after: "一件事实是一条没有性别的真理",
        night: "真理有时可能变得黯淡，但它永远不会熄灭",
        midnight: "真理在人那里获得生命力，并且展现出来"
    }
    $(document).ready(function(){
        Nlvi.search();
    });
    </script>

</body>
</html>
